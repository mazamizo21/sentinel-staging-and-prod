{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.33.93.31351",
      "templateHash": "7737299790093152895"
    }
  },
  "parameters": {
    "workspaceId": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "workbookName": {
      "type": "string",
      "defaultValue": "Cyren Threat Intelligence Dashboard (Enhanced)"
    }
  },
  "variables": {
    "workbookId": "[guid(parameters('workspaceId'), parameters('workbookName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[variables('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookName')]",
        "serializedData": "[string(createObject('version', 'Notebook/1.0', 'items', createArray(createObject('type', 1, 'content', createObject('json', '## ðŸ›¡ï¸ Cyren Threat Intelligence Dashboard (Enhanced)\n\n**Real-time visibility into Cyren IP Reputation and Malware URLs feeds**\n\nâœ… All queries validated with production data | ðŸ”„ Auto-refresh every 5 minutes\n\n---')), createObject('type', 9, 'content', createObject('version', 'KqlParametersItem/1.0', 'parameters', createArray(createObject('id', 'time-range', 'name', 'TimeRange', 'type', 4, 'value', createObject('durationMs', 3600000), 'typeSettings', createObject('selectableValues', createArray(createObject('durationMs', 3600000, 'label', '1 hour'), createObject('durationMs', 21600000, 'label', '6 hours'), createObject('durationMs', 86400000, 'label', '24 hours'), createObject('durationMs', 604800000, 'label', '7 days'), createObject('durationMs', json('2592000000'), 'label', '30 days')), 'allowCustom', true()))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| summarize \n    Total=count(), \n    IPRep=countif(source_s contains \"IP\" or source_s contains \"ip\"), \n    MalwareURLs=countif(source_s contains \"Malware\" or source_s contains \"malware\" or source_s contains \"URL\"), \n    Latest=max(TimeGenerated),\n    HoursAgo=datetime_diff(''hour'', now(), max(TimeGenerated))\n| extend Status = case(\n    HoursAgo > 7, \"ðŸ”´ Critical - No data > 7 hours\",\n    HoursAgo > 6, \"ðŸŸ¡ Warning - Data delayed\",\n    \"ðŸŸ¢ Healthy - Data flowing\"\n)\n| project Status, Total, IPRep, MalwareURLs, Latest, HoursAgo\n', 'size', 3, 'title', 'ðŸ” Data Pipeline Health (Last Hour)', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'tiles', 'tileSettings', createObject('showBorder', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| summarize\n    Total=count(),\n    PopulatedIPs=countif(isnotempty(ip_s)),\n    PopulatedURLs=countif(isnotempty(url_s)),\n    PopulatedDomains=countif(isnotempty(domain_s)),\n    PopulatedCategories=countif(isnotempty(category_s)),\n    PopulatedRisk=countif(isnotnull(risk_d)),\n    PopulatedSource=countif(isnotempty(source_s))\n| extend\n    IPPercent = round(PopulatedIPs * 100.0 / iif(Total > 0, Total, 1), 1),\n    URLPercent = round(PopulatedURLs * 100.0 / iif(Total > 0, Total, 1), 1),\n    DomainPercent = round(PopulatedDomains * 100.0 / iif(Total > 0, Total, 1), 1),\n    CategoryPercent = round(PopulatedCategories * 100.0 / iif(Total > 0, Total, 1), 1),\n    RiskPercent = round(PopulatedRisk * 100.0 / iif(Total > 0, Total, 1), 1),\n    SourcePercent = round(PopulatedSource * 100.0 / iif(Total > 0, Total, 1), 1)\n| project \n    Field = pack_array(\"IPs\", \"URLs\", \"Domains\", \"Categories\", \"Risk\", \"Source\"),\n    Value = pack_array(IPPercent, URLPercent, DomainPercent, CategoryPercent, RiskPercent, SourcePercent)\n| mv-expand Field, Value\n| project Field = tostring(Field), Value = todouble(Value)\n', 'size', 4, 'title', 'ðŸ“Š Data Quality - Field Population %', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'tiles', 'tileSettings', createObject('showBorder', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| summarize\n    TotalIndicators = count(),\n    UniqueIPs = dcountif(ip_s, isnotempty(ip_s)),\n    UniqueURLs = dcountif(url_s, isnotempty(url_s)),\n    UniqueDomains = dcountif(domain_s, isnotempty(domain_s)),\n    HighRisk = countif(Risk >= 80),\n    MediumRisk = countif(Risk between (50 .. 79)),\n    LowRisk = countif(Risk < 50)\n', 'size', 0, 'title', 'ðŸ“ˆ Threat Intelligence Overview', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'tiles', 'tileSettings', createObject('showBorder', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| extend RiskBucket = case(\n    Risk >= 80, \"Critical (80-100)\",\n    Risk >= 60, \"High (60-79)\",\n    Risk >= 40, \"Medium (40-59)\",\n    Risk >= 20, \"Low (20-39)\",\n    \"Minimal (<20)\"\n)\n| summarize Count = count() by RiskBucket, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc\n', 'size', 0, 'title', 'ðŸ“Š Risk Distribution Over Time', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'areachart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| where isnotempty(ip_s)\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| summarize\n    DetectionCount=count(),\n    MaxRisk=max(Risk),\n    Categories=make_set(category_s),\n    FirstSeen=min(TimeGenerated),\n    LastSeen=max(TimeGenerated)\n  by IP=tostring(ip_s)\n| extend DaysActive = datetime_diff(''day'', LastSeen, FirstSeen)\n| order by DetectionCount desc, MaxRisk desc\n| take 20\n| project IP, DetectionCount, MaxRisk, DaysActive, Categories, FirstSeen, LastSeen\n', 'size', 0, 'title', 'ðŸŽ¯ Top 20 Malicious IPs (Prioritized for Blocking)', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'DetectionCount', 'formatter', 8, 'formatOptions', createObject('palette', 'red')), createObject('columnMatch', 'MaxRisk', 'formatter', 18, 'formatOptions', createObject('thresholdsOptions', 'icons', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '80', 'icon', 'Sev0'), createObject('operator', '>=', 'value', '50', 'icon', 'Sev1'), createObject('operator', 'Default', 'icon', 'Sev2')))), createObject('columnMatch', 'FirstSeen', 'formatter', 6), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| where isnotempty(url_s) \n| extend ShortURL = substring(tostring(url_s), 0, 100)\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| summarize \n    DetectionCount=count(), \n    MaxRisk=max(Risk),\n    Categories=make_set(category_s),\n    FirstSeen=min(TimeGenerated),\n    LastSeen=max(TimeGenerated)\n  by ShortURL \n| order by DetectionCount desc, MaxRisk desc\n| take 20\n| project ShortURL, DetectionCount, MaxRisk, Categories, FirstSeen, LastSeen\n', 'size', 0, 'title', 'ðŸŒ Top 20 Malware URLs (For Web Proxy Filtering)', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'DetectionCount', 'formatter', 8, 'formatOptions', createObject('palette', 'red')), createObject('columnMatch', 'MaxRisk', 'formatter', 8, 'formatOptions', createObject('palette', 'redGreen')), createObject('columnMatch', 'FirstSeen', 'formatter', 6), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| extend\n    Protocol = tostring(protocol_s),\n    Port = tostring(port_d)\n| where isnotempty(Protocol) or isnotempty(Port)\n| summarize Count=count() by Protocol, Port\n| order by Count desc\n| take 15\n| extend PortLabel = strcat(Protocol, \":\", Port)\n| project PortLabel, Count\n', 'size', 1, 'title', 'ðŸŒ Attack Vectors - Protocol & Port Distribution', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| extend Source = tostring(source_s), Category = tostring(category_s)\n| where isnotempty(Source) or isnotempty(Category)\n| summarize Count=count() by Source, Category \n| order by Count desc\n| take 20\n', 'size', 1, 'title', 'ðŸ“ˆ Threat Sources & Categories', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'barchart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| extend Category = case(\n    isnotempty(category_s), tostring(category_s),\n    isnotempty(type_s), tostring(type_s),\n    isnotempty(source_s), strcat(\"Source: \", tostring(source_s)),\n    \"Uncategorized\"\n)\n| where Category !in (\"\", \"unknown\")\n| summarize Count = count() by Category\n| order by Count desc\n', 'size', 1, 'title', 'ðŸ·ï¸ Threat Categories Distribution', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| where Risk >= 50\n| extend\n    UrlValue = iif(type_s == \"url\", url_s, \"\"),\n    IpValue  = iif(type_s == \"ip\",  ip_s,  \"\")\n| extend Domain = iif(\n            isnotempty(UrlValue),\n            tostring(split(split(tostring(UrlValue), \"://\")[1], \"/\")[0]),\n            tostring(domain_s)\n        )\n| project\n    TimeGenerated,\n    Risk,\n    Domain,\n    URL    = UrlValue,\n    IP     = IpValue,\n    Category = tostring(category_s),\n    LastSeen  = TimeGenerated\n| order by TimeGenerated desc\n| take 50\n', 'size', 0, 'title', 'âš ï¸ Recent High-Risk Indicators (Risk â‰¥ 50)', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'TimeGenerated', 'formatter', 6), createObject('columnMatch', 'Risk', 'formatter', 18, 'formatOptions', createObject('thresholdsOptions', 'icons', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '90', 'icon', 'Sev0'), createObject('operator', '>=', 'value', '70', 'icon', 'Sev1'), createObject('operator', 'Default', 'icon', 'Sev2')))), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_Indicators_CL, Cyren_Indicators_CL\n\n| summarize Count = count() by bin(TimeGenerated, 1h)\n| order by TimeGenerated asc\n', 'size', 0, 'title', 'ðŸ“Š Ingestion Volume (Last 7 Days)', 'queryType', 0, 'timeContextFromParameter', 'TimeRange', 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'timechart'))), 'styleSettings', createObject(), '$schema', 'https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json'))]",
        "version": "1.0",
        "sourceId": "[parameters('workspaceId')]",
        "category": "sentinel",
        "tags": [
          "Cyren",
          "Threat Intelligence",
          "Enhanced",
          "Production"
        ]
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/workbooks', variables('workbookId'))]"
    },
    "workbookName": {
      "type": "string",
      "value": "[variables('workbookId')]"
    }
  }
}