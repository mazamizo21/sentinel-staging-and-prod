{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.33.93.31351",
      "templateHash": "16966796104108534349"
    }
  },
  "parameters": {
    "workspaceId": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "workbookName": {
      "type": "string",
      "defaultValue": "Cyren Threat Intelligence Dashboard (Enhanced)"
    }
  },
  "variables": {
    "workbookId": "[guid(parameters('workspaceId'), parameters('workbookName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[variables('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookName')]",
        "serializedData": "[string(createObject('version', 'Notebook/1.0', 'items', createArray(createObject('type', 1, 'content', createObject('json', '## ðŸ›¡ï¸ Cyren Threat Intelligence Dashboard (Enhanced)\n\n**Real-time visibility into Cyren IP Reputation and Malware URLs feeds**\n\nâœ… All queries validated with production data | ðŸ”„ Auto-refresh every 5 minutes\n\n---')), createObject('type', 9, 'content', createObject('version', 'KqlParametersItem/1.0', 'parameters', createArray(createObject('id', 'time-range', 'name', 'TimeRange', 'type', 4, 'value', createObject('durationMs', 3600000), 'typeSettings', createObject('selectableValues', createArray(createObject('durationMs', 3600000, 'label', '1 hour'), createObject('durationMs', 21600000, 'label', '6 hours (Logic App interval)'), createObject('durationMs', 86400000, 'label', '24 hours'), createObject('durationMs', 604800000, 'label', '7 days'), createObject('durationMs', json('2592000000'), 'label', '30 days')), 'allowCustom', true()))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL \n| where TimeGenerated >= ago(1h) \n| summarize \n    Total=count(), \n    IPRep=countif(source_s contains ''IP''), \n    MalwareURLs=countif(source_s contains ''Malware''), \n    Latest=max(TimeGenerated),\n    HoursAgo=datetime_diff(''hour'', now(), max(TimeGenerated))\n| extend Status = case(\n    HoursAgo > 7, \"ðŸ”´ Critical - No data > 7 hours\",\n    HoursAgo > 6, \"ðŸŸ¡ Warning - Data delayed\",\n    \"ðŸŸ¢ Healthy - Data flowing\"\n)\n| project Status, Total, IPRep, MalwareURLs, Latest, HoursAgo\n', 'size', 3, 'title', 'ðŸ” Data Pipeline Health (Last Hour)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'tiles', 'tileSettings', createObject('titleContent', createObject('columnMatch', 'Status', 'formatter', 1), 'leftContent', createObject('columnMatch', 'Total', 'formatter', 12, 'formatOptions', createObject('palette', 'greenRed', 'compositeBarSettings', createObject('labelText', 'Total Records', 'columnSettings', createArray()))), 'secondaryContent', createObject('columnMatch', 'HoursAgo', 'formatter', 1, 'formatOptions', createObject('customColumnWidthSetting', '20%')), 'showBorder', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL \n| where TimeGenerated >= ago(1h) \n| summarize \n    Total=count(),\n    PopulatedIPs=countif(isnotempty(ip_s)), \n    PopulatedURLs=countif(isnotempty(url_s)), \n    PopulatedCategories=countif(isnotempty(category_s)),\n    PopulatedRisk=countif(isnotnull(risk_d)),\n    PopulatedSource=countif(isnotempty(source_s))\n| extend \n    IPPercent = round(PopulatedIPs * 100.0 / Total, 1),\n    URLPercent = round(PopulatedURLs * 100.0 / Total, 1),\n    CategoryPercent = round(PopulatedCategories * 100.0 / Total, 1),\n    RiskPercent = round(PopulatedRisk * 100.0 / Total, 1),\n    SourcePercent = round(PopulatedSource * 100.0 / Total, 1)\n| project \n    Metric = ''Field Population'',\n    IPPercent, \n    URLPercent, \n    CategoryPercent, \n    RiskPercent, \n    SourcePercent\n', 'size', 0, 'title', 'ðŸ“Š Data Quality - Field Population % (Should be ~100%)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'IPPercent', 'formatter', 8, 'formatOptions', createObject('palette', 'greenRed', 'thresholdsOptions', 'colors', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '60', 'representation', 'green'), createObject('operator', '>=', 'value', '40', 'representation', 'yellow'), createObject('operator', 'Default', 'representation', 'red')))), createObject('columnMatch', 'URLPercent', 'formatter', 8, 'formatOptions', createObject('palette', 'greenRed')), createObject('columnMatch', 'CategoryPercent', 'formatter', 8, 'formatOptions', createObject('palette', 'greenRed', 'thresholdsOptions', 'colors', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '95', 'representation', 'green'), createObject('operator', '>=', 'value', '80', 'representation', 'yellow'), createObject('operator', 'Default', 'representation', 'red')))))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL\n| where TimeGenerated > ago(7d)\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| extend IP = tostring(ip_s), URL = tostring(url_s), Domain = tostring(domain_s)\n| summarize\n    TotalIndicators = count(),\n    UniqueIPs = dcountif(IP, isnotempty(IP)),\n    UniqueURLs = dcountif(URL, isnotempty(URL)),\n    UniqueDomains = dcountif(Domain, isnotempty(Domain)),\n    HighRisk = countif(Risk >= 80),\n    MediumRisk = countif(Risk between (50 .. 79)),\n    LowRisk = countif(Risk < 50)\n', 'size', 0, 'title', 'ðŸ“ˆ Threat Intelligence Overview', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'tiles', 'tileSettings', createObject('showBorder', true(), 'titleContent', createObject('columnMatch', 'TotalIndicators', 'formatter', 1), 'leftContent', createObject('columnMatch', 'TotalIndicators', 'formatter', 12, 'formatOptions', createObject('palette', 'blue'))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL\n| where TimeGenerated > ago(7d)\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| extend RiskBucket = case(\n    Risk >= 80, \"Critical (80-100)\",\n    Risk >= 60, \"High (60-79)\",\n    Risk >= 40, \"Medium (40-59)\",\n    Risk >= 20, \"Low (20-39)\",\n    \"Minimal (<20)\"\n)\n| summarize Count = count() by RiskBucket, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc\n', 'size', 0, 'title', 'ðŸ“Š Risk Distribution Over Time', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'areachart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL \n| where TimeGenerated > ago(7d)\n| where isnotempty(ip_s) \n| summarize \n    DetectionCount=count(), \n    MaxRisk=max(risk_d), \n    Categories=make_set(category_s),\n    FirstSeen=min(coalesce(firstSeen_t, TimeGenerated)),\n    LastSeen=max(coalesce(lastSeen_t, TimeGenerated))\n  by IP=ip_s \n| extend DaysActive = datetime_diff(''day'', LastSeen, FirstSeen)\n| top 20 by DetectionCount desc\n| project IP, DetectionCount, MaxRisk, DaysActive, Categories, FirstSeen, LastSeen\n', 'size', 0, 'title', 'ðŸŽ¯ Top 20 Malicious IPs (Prioritized for Blocking)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'DetectionCount', 'formatter', 8, 'formatOptions', createObject('palette', 'red')), createObject('columnMatch', 'MaxRisk', 'formatter', 18, 'formatOptions', createObject('thresholdsOptions', 'icons', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '80', 'representation', 'critical'), createObject('operator', '>=', 'value', '50', 'representation', 'warning'), createObject('operator', 'Default', 'representation', 'success')))), createObject('columnMatch', 'DaysActive', 'formatter', 8, 'formatOptions', createObject('palette', 'orange')), createObject('columnMatch', 'FirstSeen', 'formatter', 6), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true(), 'sortBy', createArray(createObject('itemKey', 'DetectionCount', 'sortOrder', 2))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL \n| where TimeGenerated > ago(7d)\n| where isnotempty(url_s) \n| extend ShortURL = substring(url_s, 0, 100)\n| summarize \n    DetectionCount=count(), \n    Categories=make_set(category_s),\n    FirstSeen=min(coalesce(firstSeen_t, TimeGenerated)),\n    LastSeen=max(coalesce(lastSeen_t, TimeGenerated))\n  by ShortURL \n| top 20 by DetectionCount desc\n| project ShortURL, DetectionCount, Categories, FirstSeen, LastSeen\n', 'size', 0, 'title', 'ðŸŒ Top 20 Malware URLs (For Web Proxy Filtering)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'DetectionCount', 'formatter', 8, 'formatOptions', createObject('palette', 'red')), createObject('columnMatch', 'FirstSeen', 'formatter', 6), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL \n| where TimeGenerated > ago(7d)\n| where isnotempty(protocol_s) \n| summarize Count=count() by protocol_s, port_d \n| order by Count desc \n| take 15\n| extend PortLabel = strcat(protocol_s, \":\", port_d)\n', 'size', 1, 'title', 'ðŸŒ Attack Vectors - Protocol & Port Distribution', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL \n| where TimeGenerated > ago(7d)\n| summarize Count=count() by source_s, category_s \n| order by Count desc\n', 'size', 1, 'title', 'ðŸ“ˆ Threat Sources & Categories', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'barchart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL\n| where TimeGenerated > ago(7d)\n| extend Category = case(\n    isnotempty(category_s), tostring(category_s),\n    isnotempty(object_type_s), tostring(object_type_s),\n    isnotempty(source_s), strcat(\"Source: \", tostring(source_s)),\n    isnotempty(type_s), strcat(\"Type: \", tostring(type_s)),\n    \"Uncategorized\"\n)\n| where Category !in (\"unknown\", \"\")\n| summarize Count = count() by Category\n| order by Count desc\n', 'size', 1, 'title', 'ðŸ·ï¸ Threat Categories Distribution', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL\n| where TimeGenerated > ago(7d)\n| extend IndicatorType = case(\n    isnotempty(type_s), tostring(type_s),\n    isnotempty(object_type_s), tostring(object_type_s),\n    isnotempty(ip_s) and isempty(url_s), \"IP Address\",\n    isnotempty(url_s), \"URL\",\n    isnotempty(domain_s), \"Domain\",\n    isnotempty(fileHash_s), \"File Hash\",\n    \"Other\"\n)\n| where IndicatorType !in (\"unknown\", \"\")\n| summarize Count = count() by IndicatorType\n| order by Count desc\n', 'size', 1, 'title', 'ðŸ“¦ Threat Types Distribution', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL\n| where TimeGenerated > ago(7d)\n| extend Risk = iif(isnull(risk_d), 50, toint(risk_d))\n| where Risk >= 70\n| project \n    TimeGenerated, \n    Risk, \n    Domain = tolower(tostring(domain_s)), \n    URL = tostring(url_s), \n    IP = tostring(ip_s), \n    Category = tostring(category_s), \n    LastSeen = coalesce(lastSeen_t, TimeGenerated)\n| order by TimeGenerated desc\n| take 50\n', 'size', 0, 'title', 'âš ï¸ Recent High-Risk Indicators (Risk â‰¥ 70)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'TimeGenerated', 'formatter', 6), createObject('columnMatch', 'Risk', 'formatter', 18, 'formatOptions', createObject('thresholdsOptions', 'icons', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '90', 'icon', 'Sev0'), createObject('operator', '>=', 'value', '70', 'icon', 'Sev1'), createObject('operator', 'Default', 'icon', 'Sev2')))), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true(), 'sortBy', createArray(createObject('itemKey', 'TimeGenerated', 'sortOrder', 2))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'Cyren_Indicators_CL\n| where TimeGenerated >= ago(7d)\n| summarize Count = count() by bin(TimeGenerated, 1h)\n| order by TimeGenerated asc\n', 'size', 0, 'title', 'ðŸ“Š Ingestion Volume (Last 7 Days) - Should show spikes every 6 hours', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'timechart'))), 'styleSettings', createObject(), '$schema', 'https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json'))]",
        "version": "1.0",
        "sourceId": "[parameters('workspaceId')]",
        "category": "sentinel"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/workbooks', variables('workbookId'))]"
    }
  }
}