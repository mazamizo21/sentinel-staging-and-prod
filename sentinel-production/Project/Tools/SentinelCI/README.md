# Sentinel CI/CD Tools

A complete toolkit for developing, validating, and deploying Microsoft Sentinel CCF (Codeless Connector Framework) solutions to the Azure-Sentinel GitHub repository.

---

## ğŸ“‹ Table of Contents

- [Quick Start](#-quick-start)
- [Scripts Overview](#-scripts-overview)
- [Detailed Usage](#-detailed-usage)
- [Workflow](#-workflow)
- [Configuration](#-configuration)
- [Common arm-ttk Fixes](#-common-arm-ttk-fixes)
- [Folder Structure](#-folder-structure)
- [Requirements](#-requirements)
- [Troubleshooting](#-troubleshooting)

---

## ğŸš€ Quick Start

```powershell
# Navigate to the repo root
cd /Users/tazjack/Documents/sentinel-staging-and-prod/sentinel-production

# 1. Validate a solution
pwsh ./Project/Tools/SentinelCI/Validate-Solution.ps1 -SolutionName "Cyren-CCF"

# 2. Fix common issues automatically
pwsh ./Project/Tools/SentinelCI/Fix-CommonIssues.ps1 -SolutionName "Cyren-CCF"

# 3. Deploy to GitHub
pwsh ./Project/Tools/SentinelCI/Deploy-ToGitHub.ps1 -SolutionName "Cyren-CCF" -GitHubToken "ghp_xxx"

# 4. Or run the full pipeline (validate + deploy)
pwsh ./Project/Tools/SentinelCI/Run-Pipeline.ps1 -SolutionName "Cyren-CCF" -GitHubToken "ghp_xxx"
```

---

## ğŸ“¦ Scripts Overview

| Script | Description | Key Parameters |
|--------|-------------|----------------|
| **`Validate-Solution.ps1`** | Run arm-ttk validation | `-SolutionName`, `-Detailed`, `-SaveLog` |
| **`Deploy-ToGitHub.ps1`** | Copy to fork and push | `-SolutionName`, `-GitHubToken`, `-BranchName` |
| **`Run-Pipeline.ps1`** | Full CI/CD pipeline | `-SolutionName`, `-GitHubToken`, `-SkipValidation` |
| **`New-Solution.ps1`** | Scaffold new CCF solution | `-SolutionName`, `-Publisher`, `-TableName` |
| **`Fix-CommonIssues.ps1`** | Auto-fix arm-ttk issues | `-SolutionName`, `-DryRun` |
| **`Config.ps1`** | Configuration settings | Edit directly |

---

## ğŸ“– Detailed Usage

### Validate-Solution.ps1

Runs Microsoft's arm-ttk (ARM Template Test Toolkit) against your solution.

```powershell
# Basic validation
pwsh ./Validate-Solution.ps1 -SolutionName "Cyren-CCF"

# Detailed output with all test results
pwsh ./Validate-Solution.ps1 -SolutionName "Cyren-CCF" -Detailed

# Save log to Project/Docs/Logs/
pwsh ./Validate-Solution.ps1 -SolutionName "Cyren-CCF" -SaveLog
```

**Output:**
```
=== Sentinel Solution Validation ===
Solution: Cyren-CCF
[OK] arm-ttk loaded
Running arm-ttk validation...
[PASS] All 51 tests passed!
```

---

### Deploy-ToGitHub.ps1

Copies your solution to the Azure-Sentinel fork and pushes to GitHub.

```powershell
# Deploy with GitHub token
pwsh ./Deploy-ToGitHub.ps1 -SolutionName "Cyren-CCF" -GitHubToken "ghp_xxx"

# Custom branch name
pwsh ./Deploy-ToGitHub.ps1 -SolutionName "Cyren-CCF" -GitHubToken "ghp_xxx" -BranchName "feature/my-connector"

# Skip push (just copy and commit locally)
pwsh ./Deploy-ToGitHub.ps1 -SolutionName "Cyren-CCF" -SkipPush
```

**What it does:**
1. Copies solution files to `Azure-Sentinel/Solutions/<SolutionName>/`
2. Creates a feature branch
3. Commits changes
4. Pushes to your GitHub fork
5. Provides PR creation link

---

### Run-Pipeline.ps1

Runs the complete CI/CD pipeline: validation â†’ deployment.

```powershell
# Full pipeline
pwsh ./Run-Pipeline.ps1 -SolutionName "Cyren-CCF" -GitHubToken "ghp_xxx"

# Skip validation (deploy only)
pwsh ./Run-Pipeline.ps1 -SolutionName "Cyren-CCF" -GitHubToken "ghp_xxx" -SkipValidation
```

---

### New-Solution.ps1

Scaffolds a new CCF connector solution with all required files.

```powershell
# Create new solution
pwsh ./New-Solution.ps1 -SolutionName "Cloudflare" -Publisher "Cloudflare" -TableName "Cloudflare_Logs_CL"

# With custom API endpoint
pwsh ./New-Solution.ps1 -SolutionName "Cloudflare" -Publisher "Cloudflare" -TableName "Cloudflare_Logs_CL" -ApiEndpoint "https://api.cloudflare.com/v4/logs"
```

**Creates:**
```
Cloudflare-CCF-Hub/
â”œâ”€â”€ Package/                    # (empty, generated by V3 tool)
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ Solution_Cloudflare.json
â”œâ”€â”€ Data Connectors/
â”‚   â””â”€â”€ Cloudflare_CCF/
â”‚       â”œâ”€â”€ Cloudflare_ConnectorDefinition.json
â”‚       â”œâ”€â”€ Cloudflare_PollerConfig.json
â”‚       â””â”€â”€ Cloudflare_Table.json
â”œâ”€â”€ SolutionMetadata.json
â”œâ”€â”€ ReleaseNotes.md
â””â”€â”€ README.md
```

---

### Fix-CommonIssues.ps1

Automatically fixes common arm-ttk validation failures.

```powershell
# Preview fixes (dry run)
pwsh ./Fix-CommonIssues.ps1 -SolutionName "Cyren-CCF" -DryRun

# Apply fixes
pwsh ./Fix-CommonIssues.ps1 -SolutionName "Cyren-CCF"
```

**Fixes applied:**
- `"id"` â†’ `"connectorId"` in connector definitions
- Removes empty `"value": []` from connectivityCriteria
- Removes empty `groupByAlertDetails` and `groupByCustomDetails`
- Fixes empty `ApiKeyIdentifier` â†’ `"Bearer"`
- Renames `feedId` â†’ `feed` in query parameters

---

## ğŸ”„ Workflow

### For New Solutions

```
1. Create solution    â†’  New-Solution.ps1
2. Edit configs       â†’  Customize connector definition, poller, table
3. Validate           â†’  Validate-Solution.ps1
4. Fix issues         â†’  Fix-CommonIssues.ps1 (or manual)
5. Deploy             â†’  Deploy-ToGitHub.ps1
6. Create PR          â†’  GitHub web UI
```

### For Existing Solutions

```
1. Make changes       â†’  Edit files in *-Hub folder
2. Validate           â†’  Validate-Solution.ps1
3. Fix issues         â†’  Fix-CommonIssues.ps1
4. Deploy             â†’  Deploy-ToGitHub.ps1
5. Create PR          â†’  GitHub web UI
```

---

## âš™ï¸ Configuration

Edit `Config.ps1` to customize settings:

```powershell
$script:Config = @{
    # Your GitHub username
    GitHubUsername = "mazamizo21"
    
    # Path to Azure-Sentinel fork (relative to repo root)
    AzureSentinelPath = "Project/Tools/Azure-Sentinel"
    
    # Path to arm-ttk module
    ArmTtkPath = "Project/Tools/arm-ttk/arm-ttk/arm-ttk.psd1"
    
    # Logs directory
    LogsPath = "Project/Docs/Logs"
    
    # Solution folder suffix pattern
    SolutionSuffix = "-Hub"
    
    # GitHub remote name
    GitHubRemoteName = "fork"
    
    # Branch prefix for PRs
    BranchPrefix = "feature/"
}
```

---

## ğŸ”§ Common arm-ttk Fixes

| Issue | Fix |
|-------|-----|
| `IDs Should Be Derived From ResourceIDs` | Rename `"id"` to `"connectorId"` |
| `Template Should Not Contain Blanks` | Remove empty arrays `[]` and objects `{}` |
| `Variables Must Be Referenced` | Remove unused variables |
| `Parameters Must Be Referenced` | Add outputs that reference parameters |
| `Location Should Be In Outputs` | Add `"location": "[location()]"` to outputs |
| `DeploymentTemplate Must Not Contain Hardcoded Uri` | Use `[environment().resourceManager]` |

---

## ğŸ“ Folder Structure

```
sentinel-production/
â”œâ”€â”€ Project/
â”‚   â”œâ”€â”€ Tools/
â”‚   â”‚   â”œâ”€â”€ SentinelCI/           # â† These scripts
â”‚   â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â”‚   â”œâ”€â”€ Config.ps1
â”‚   â”‚   â”‚   â”œâ”€â”€ Validate-Solution.ps1
â”‚   â”‚   â”‚   â”œâ”€â”€ Deploy-ToGitHub.ps1
â”‚   â”‚   â”‚   â”œâ”€â”€ Run-Pipeline.ps1
â”‚   â”‚   â”‚   â”œâ”€â”€ New-Solution.ps1
â”‚   â”‚   â”‚   â””â”€â”€ Fix-CommonIssues.ps1
â”‚   â”‚   â”œâ”€â”€ arm-ttk/              # Microsoft ARM TTK
â”‚   â”‚   â””â”€â”€ Azure-Sentinel/       # Your GitHub fork
â”‚   â””â”€â”€ Docs/
â”‚       â””â”€â”€ Logs/                 # Validation logs
â”œâ”€â”€ Cyren-CCF-Hub/                # Cyren solution
â”œâ”€â”€ Tacitred-CCF-Hub/             # TacitRed solution
â””â”€â”€ TAZ-DOCS/                     # Your documentation
```

---

## ğŸ“‹ Requirements

- **PowerShell 7+** (`pwsh`) - Cross-platform PowerShell
- **Git** - For version control and pushing to GitHub
- **arm-ttk** - Vendored in `Project/Tools/arm-ttk/`
- **Azure-Sentinel fork** - Vendored in `Project/Tools/Azure-Sentinel/`
- **GitHub Personal Access Token** - For pushing to your fork

### Install PowerShell 7 (if needed)

```bash
# macOS
brew install powershell

# Verify
pwsh --version
```

---

## ğŸ” Troubleshooting

### "Solution folder not found"
The script looks for folders matching these patterns:
- `<SolutionName>-Hub`
- `<SolutionName>-CCF-Hub`
- `<SolutionName>`

Make sure your solution folder exists and matches one of these patterns.

### "arm-ttk not found"
Ensure arm-ttk is cloned in `Project/Tools/arm-ttk/`. If missing:
```bash
cd Project/Tools
git clone https://github.com/Azure/arm-ttk.git
```

### "Cannot push to GitHub"
1. Verify your GitHub token has `repo` scope
2. Check the fork remote exists:
   ```bash
   cd Project/Tools/Azure-Sentinel
   git remote -v
   ```
3. Add fork remote if missing:
   ```bash
   git remote add fork https://github.com/mazamizo21/Azure-Sentinel.git
   ```

### "Validation failed"
Run with `-Detailed` to see specific failures:
```powershell
pwsh ./Validate-Solution.ps1 -SolutionName "MySolution" -Detailed
```

---

## ğŸ“ Support

- **Logs**: Check `Project/Docs/Logs/` for validation logs
- **arm-ttk docs**: https://github.com/Azure/arm-ttk
- **Sentinel solutions**: https://github.com/Azure/Azure-Sentinel/tree/master/Solutions
