{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "string",
      "metadata": {
        "description": "Microsoft Sentinel workspace name"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "tacitRedApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "TacitRed API Key - will be stored securely in Key Vault"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "[concat('kv-tacitred-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of the Key Vault for secure credential storage"
      }
    },
    "enablePrivateEndpoint": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable private endpoint for Key Vault (requires VNet)"
      }
    },
    "subnetId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Subnet ID for private endpoint (required if enablePrivateEndpoint is true)"
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace'))]",
    "uamiName": "[concat('uami-tacitred-secure-', uniqueString(resourceGroup().id))]",
    "keyVaultName": "[parameters('keyVaultName')]",
    "dceName": "[concat('dce-tacitred-secure-', uniqueString(resourceGroup().id))]",
    "dcrName": "[concat('dcr-tacitred-secure-', uniqueString(resourceGroup().id))]",
    "tableName": "TacitRed_Findings_CL",
    "connectorName": "TacitRedFindings-Secure"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('uamiName')]",
      "location": "[parameters('workspace-location')]"
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]"
      ],
      "properties": {
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "tenantId": "[subscription().tenantId]",
        "accessPolicies": [
          {
            "tenantId": "[subscription().tenantId]",
            "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))).principalId]",
            "permissions": {
              "secrets": ["get", "list"]
            }
          }
        ],
        "enabledForDeployment": false,
        "enabledForTemplateDeployment": true,
        "enabledForDiskEncryption": false,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "enablePurgeProtection": true,
        "networkAcls": {
          "defaultAction": "[if(parameters('enablePrivateEndpoint'), 'Deny', 'Allow')]",
          "bypass": "AzureServices"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[concat(variables('keyVaultName'), '/tacitred-api-key')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ],
      "properties": {
        "value": "[parameters('tacitRedApiKey')]",
        "attributes": {
          "enabled": true,
          "exp": "[dateTimeAdd(utcNow(), 'P1Y')]"
        },
        "contentType": "TacitRed API Key for Sentinel Connector"
      }
    },
    {
      "condition": "[parameters('enablePrivateEndpoint')]",
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-09-01",
      "name": "[concat(variables('keyVaultName'), '-pe')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ],
      "properties": {
        "subnet": {
          "id": "[parameters('subnetId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "keyVaultConnection",
            "properties": {
              "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
              "groupIds": ["vault"]
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2022-06-01",
      "name": "[variables('dceName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "networkAcls": {
          "publicNetworkAccess": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('dcrName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]"
      ],
      "properties": {
        "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
        "streamDeclarations": {
          "[concat('Custom-', variables('tableName'))]": {
            "columns": [
              {"name": "TimeGenerated", "type": "datetime"},
              {"name": "email_s", "type": "string"},
              {"name": "domain_s", "type": "string"},
              {"name": "confidence_d", "type": "real"},
              {"name": "findingType_s", "type": "string"},
              {"name": "source_s", "type": "string"},
              {"name": "created_at_t", "type": "datetime"},
              {"name": "updated_at_t", "type": "datetime"}
            ]
          }
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "clv2ws1"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": ["[concat('Custom-', variables('tableName'))]"],
            "destinations": ["clv2ws1"],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "[concat('Custom-', variables('tableName'))]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('workspace'), '/', variables('tableName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))]"
      ],
      "properties": {
        "totalRetentionInDays": 30,
        "plan": "Analytics",
        "schema": {
          "name": "[variables('tableName')]",
          "columns": [
            {"name": "TimeGenerated", "type": "datetime"},
            {"name": "email_s", "type": "string"},
            {"name": "domain_s", "type": "string"},
            {"name": "confidence_d", "type": "real"},
            {"name": "findingType_s", "type": "string"},
            {"name": "source_s", "type": "string"},
            {"name": "created_at_t", "type": "datetime"},
            {"name": "updated_at_t", "type": "datetime"}
          ]
        }
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(variables('workspaceResourceId'), variables('uamiName'), 'sentinel-contributor')]",
      "scope": "[variables('workspaceResourceId')]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ab8e14d6-4a74-4a29-9ba8-549422addade')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))).principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(variables('keyVaultName'), variables('uamiName'), 'key-vault-secrets-user')]",
      "scope": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))).principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
      "name": "keyVaultDiagnostics",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ],
      "properties": {
        "workspaceId": "[variables('workspaceResourceId')]",
        "logs": [
          {
            "category": "AuditEvent",
            "enabled": true,
            "retentionPolicy": {
              "enabled": true,
              "days": 365
            }
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "configure-secure-tacitred-connector",
      "location": "[parameters('workspace-location')]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]": {}
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), 'tacitred-api-key')]",
        "[resourceId('Microsoft.Authorization/roleAssignments', guid(variables('keyVaultName'), variables('uamiName'), 'key-vault-secrets-user'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), variables('tableName'))]"
      ],
      "properties": {
        "azCliVersion": "2.51.0",
        "timeout": "PT20M",
        "cleanupPreference": "OnSuccess",
        "retentionInterval": "P1D",
        "environmentVariables": [
          {
            "name": "SUBSCRIPTION_ID",
            "value": "[subscription().subscriptionId]"
          },
          {
            "name": "WORKSPACE_ID",
            "value": "[variables('workspaceResourceId')]"
          },
          {
            "name": "DCE_ENDPOINT",
            "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))).logsIngestion.endpoint]"
          },
          {
            "name": "DCR_IMMUTABLE_ID",
            "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))).immutableId]"
          },
          {
            "name": "KEY_VAULT_NAME",
            "value": "[variables('keyVaultName')]"
          }
        ],
        "scriptContent": "#!/usr/bin/env bash\nset -euo pipefail\n\necho 'Logging in with managed identity'\naz login --identity --allow-no-subscriptions >/dev/null\n\necho \"Setting subscription ${SUBSCRIPTION_ID}\"\naz account set --subscription \"${SUBSCRIPTION_ID}\"\n\n# Allow RBAC propagation\nsleep 30\n\nBASE_URL=\"https://management.azure.com${WORKSPACE_ID}/providers/Microsoft.SecurityInsights\"\n\necho 'Retrieving API key from Key Vault...'\nAPI_KEY=$(az keyvault secret show --vault-name \"${KEY_VAULT_NAME}\" --name \"tacitred-api-key\" --query \"value\" --output tsv)\n\necho 'Creating TacitRed connector definition...'\naz rest --method PUT --url \"${BASE_URL}/dataConnectorDefinitions/TacitRedThreatIntel?api-version=2024-09-01\" --headers \"Content-Type=application/json\" --body @- <<'DEF_EOF'\n{\n  \"kind\": \"Customizable\",\n  \"properties\": {\n    \"connectorUiConfig\": {\n      \"id\": \"TacitRedThreatIntel\",\n      \"title\": \"TacitRed Compromised Credentials (Secure)\",\n      \"publisher\": \"TacitRed\",\n      \"descriptionMarkdown\": \"Securely ingest compromised credential data from TacitRed using Azure Key Vault for credential management.\",\n      \"graphQueriesTableName\": \"TacitRed_Findings_CL\",\n      \"graphQueries\": [{\n        \"metricName\": \"Total TacitRed findings received\",\n        \"legend\": \"TacitRed Findings\",\n        \"baseQuery\": \"TacitRed_Findings_CL\"\n      }],\n      \"sampleQueries\": [{\n        \"description\": \"Recent compromised credentials\",\n        \"query\": \"TacitRed_Findings_CL | where TimeGenerated >= ago(7d) | where findingType_s == 'compromised_credential'\"\n      }],\n      \"dataTypes\": [{\n        \"name\": \"TacitRed_Findings_CL\",\n        \"lastDataReceivedQuery\": \"TacitRed_Findings_CL | summarize Time = max(TimeGenerated) | where isnotempty(Time)\"\n      }],\n      \"connectivityCriteria\": [{ \"type\": \"HasDataConnectors\", \"value\": [] }],\n      \"availability\": { \"status\": \"Available\", \"isPreview\": false },\n      \"permissions\": {\n        \"resourceProvider\": [{\n          \"provider\": \"Microsoft.OperationalInsights/workspaces\",\n          \"permissionsDisplayText\": \"read and write permissions required\",\n          \"providerDisplayName\": \"Workspace\",\n          \"scope\": \"Workspace\",\n          \"requiredPermissions\": { \"write\": true, \"read\": true, \"delete\": false }\n        }],\n        \"customs\": [{\n          \"name\": \"Azure Key Vault Access\",\n          \"description\": \"Access to Azure Key Vault for secure credential retrieval\"\n        }]\n      },\n      \"instructionSteps\": [{\n        \"title\": \"Secure Configuration\",\n        \"description\": \"This connector uses Azure Key Vault for secure credential management. API keys are encrypted at rest and accessed via managed identity.\"\n      }]\n    }\n  }\n}\nDEF_EOF\n\necho 'Creating secure TacitRed connector...'\naz rest --method PUT --url \"${BASE_URL}/dataConnectors/${CONNECTOR_NAME}?api-version=2023-02-01-preview\" --headers \"Content-Type=application/json\" --body @- <<EOF\n{\n  \"kind\": \"RestApiPoller\",\n  \"properties\": {\n    \"connectorDefinitionName\": \"TacitRedThreatIntel\",\n    \"dataType\": \"TacitRed_Findings_CL\",\n    \"dcrConfig\": {\n      \"streamName\": \"Custom-TacitRed_Findings_CL\",\n      \"dataCollectionEndpoint\": \"${DCE_ENDPOINT}\",\n      \"dataCollectionRuleImmutableId\": \"${DCR_IMMUTABLE_ID}\"\n    },\n    \"auth\": {\n      \"type\": \"APIKey\",\n      \"ApiKey\": \"${API_KEY}\",\n      \"ApiKeyName\": \"Authorization\"\n    },\n    \"request\": {\n      \"apiEndpoint\": \"https://app.tacitred.com/api/v1/findings\",\n      \"httpMethod\": \"GET\",\n      \"queryParameters\": { \"page_size\": 100 },\n      \"queryWindowInMin\": 60,\n      \"queryTimeFormat\": \"yyyy-MM-ddTHH:mm:ssZ\",\n      \"startTimeAttributeName\": \"from\",\n      \"endTimeAttributeName\": \"until\",\n      \"rateLimitQps\": 10,\n      \"retryCount\": 3,\n      \"timeoutInSeconds\": 60,\n      \"headers\": { \"Accept\": \"application/json\", \"User-Agent\": \"Microsoft-Sentinel-TacitRed-Secure/1.0\" }\n    },\n    \"paging\": { \"pagingType\": \"LinkHeader\", \"linkHeaderRelLinkName\": \"rel=next\" },\n    \"response\": { \"eventsJsonPaths\": [\"$.results\"] }\n  }\n}\nEOF\n\necho 'Secure TacitRed connector configured successfully'\necho 'API key retrieved from Key Vault and connector created with enhanced security'"
      }
    }
  ],
  "outputs": {
    "keyVaultName": {
      "type": "string",
      "value": "[variables('keyVaultName')]"
    },
    "keyVaultId": {
      "type": "string",
      "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
    },
    "managedIdentityId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]"
    },
    "dcrImmutableId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrName'))).immutableId]"
    },
    "securityFeatures": {
      "type": "object",
      "value": {
        "keyVaultIntegration": true,
        "managedIdentityAuth": true,
        "encryptedCredentials": true,
        "auditLogging": true,
        "privateEndpoint": "[parameters('enablePrivateEndpoint')]",
        "credentialRotationSupport": true
      }
    }
  }
}
