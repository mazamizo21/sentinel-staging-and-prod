{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Microsoft Sentinel workspace"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "tacitRedApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "TacitRed API Key (obtained from TacitRed admin console)"
      }
    },
    "cyrenIPJwtToken": {
      "type": "securestring",
      "metadata": {
        "description": "Cyren JWT Token for IP Reputation feed"
      }
    },
    "cyrenMalwareJwtToken": {
      "type": "securestring",
      "metadata": {
        "description": "Cyren JWT Token for Malware URLs feed"
      }
    },
    "pollingFrequencyMinutes": {
      "type": "int",
      "defaultValue": 360,
      "allowedValues": [
        60,
        360,
        720,
        1440
      ],
      "metadata": {
        "description": "Polling frequency in minutes"
      }
    },
    "deployAnalytics": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy analytics rules"
      }
    },
    "deployWorkbooks": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy visualization workbooks"
      }
    }
  },
  "variables": {
    "dceName": "dce-threatintel-feeds",
    "dcrTacitRedName": "dcr-tacitred-findings",
    "dcrCyrenIPName": "dcr-cyren-ip",
    "dcrCyrenMalwareName": "dcr-cyren-malware",
    "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
    "connectorDefinitionName": "ThreatIntelligenceFeeds"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "deployInfrastructure",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
            {
              "type": "Microsoft.Insights/dataCollectionEndpoints",
              "apiVersion": "2022-06-01",
              "name": "[variables('dceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "networkAcls": {
                  "publicNetworkAccess": "Enabled"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[concat(parameters('workspaceName'), '/TacitRed_Findings_CL')]",
              "properties": {
                "schema": {
                  "name": "TacitRed_Findings_CL",
                  "columns": [
                    { "name": "TimeGenerated", "type": "datetime" },
                    { "name": "email_s", "type": "string" },
                    { "name": "domain_s", "type": "string" },
                    { "name": "findingType_s", "type": "string" },
                    { "name": "confidence_d", "type": "int" },
                    { "name": "firstSeen_t", "type": "datetime" },
                    { "name": "lastSeen_t", "type": "datetime" },
                    { "name": "source_s", "type": "string" },
                    { "name": "severity_s", "type": "string" }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[concat(parameters('workspaceName'), '/Cyren_Indicators_CL')]",
              "properties": {
                "schema": {
                  "name": "Cyren_Indicators_CL",
                  "columns": [
                    { "name": "TimeGenerated", "type": "datetime" },
                    { "name": "ip_s", "type": "string" },
                    { "name": "url_s", "type": "string" },
                    { "name": "domain_s", "type": "string" },
                    { "name": "fileHash_s", "type": "string" },
                    { "name": "category_s", "type": "string" },
                    { "name": "risk_d", "type": "int" },
                    { "name": "source_s", "type": "string" },
                    { "name": "protocol_s", "type": "string" },
                    { "name": "port_d", "type": "int" }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2022-06-01",
              "name": "[variables('dcrTacitRedName')]",
              "location": "[parameters('location')]",
              "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), 'TacitRed_Findings_CL')]"
              ],
              "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "streamDeclarations": {
                  "Custom-TacitRed_Findings_CL": {
                    "columns": [
                      { "name": "TimeGenerated", "type": "datetime" },
                      { "name": "email_s", "type": "string" },
                      { "name": "domain_s", "type": "string" },
                      { "name": "findingType_s", "type": "string" },
                      { "name": "confidence_d", "type": "int" },
                      { "name": "firstSeen_t", "type": "datetime" },
                      { "name": "lastSeen_t", "type": "datetime" },
                      { "name": "source_s", "type": "string" },
                      { "name": "severity_s", "type": "string" }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [ "Custom-TacitRed_Findings_CL" ],
                    "destinations": [ "clv2ws1" ],
                    "transformKql": "source | extend TimeGenerated = now()",
                    "outputStream": "Custom-TacitRed_Findings_CL"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2022-06-01",
              "name": "[variables('dcrCyrenIPName')]",
              "location": "[parameters('location')]",
              "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), 'Cyren_Indicators_CL')]"
              ],
              "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "streamDeclarations": {
                  "Custom-Cyren_Indicators_CL": {
                    "columns": [
                      { "name": "TimeGenerated", "type": "datetime" },
                      { "name": "ip_s", "type": "string" },
                      { "name": "url_s", "type": "string" },
                      { "name": "domain_s", "type": "string" },
                      { "name": "category_s", "type": "string" },
                      { "name": "risk_d", "type": "int" },
                      { "name": "source_s", "type": "string" }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [ "Custom-Cyren_Indicators_CL" ],
                    "destinations": [ "clv2ws1" ],
                    "transformKql": "source | extend TimeGenerated = now()",
                    "outputStream": "Custom-Cyren_Indicators_CL"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2022-06-01",
              "name": "[variables('dcrCyrenMalwareName')]",
              "location": "[parameters('location')]",
              "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), 'Cyren_Indicators_CL')]"
              ],
              "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
                "streamDeclarations": {
                  "Custom-Cyren_Indicators_CL": {
                    "columns": [
                      { "name": "TimeGenerated", "type": "datetime" },
                      { "name": "url_s", "type": "string" },
                      { "name": "domain_s", "type": "string" },
                      { "name": "fileHash_s", "type": "string" },
                      { "name": "category_s", "type": "string" },
                      { "name": "risk_d", "type": "int" },
                      { "name": "source_s", "type": "string" }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [ "Custom-Cyren_Indicators_CL" ],
                    "destinations": [ "clv2ws1" ],
                    "transformKql": "source | extend TimeGenerated = now()",
                    "outputStream": "Custom-Cyren_Indicators_CL"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "dceEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))).logsIngestion.endpoint]"
            },
            "tacitRedDcrId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrTacitRedName'))).immutableId]"
            },
            "cyrenIPDcrId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrCyrenIPName'))).immutableId]"
            },
            "cyrenMalwareDcrId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('dcrCyrenMalwareName'))).immutableId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "deployCCFConnectors",
      "dependsOn": [
        "deployInfrastructure"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "parameters": {
          "workspaceName": {
            "value": "[parameters('workspaceName')]"
          },
          "dceEndpoint": {
            "value": "[reference('deployInfrastructure').outputs.dceEndpoint.value]"
          },
          "tacitRedDcrId": {
            "value": "[reference('deployInfrastructure').outputs.tacitRedDcrId.value]"
          },
          "cyrenIPDcrId": {
            "value": "[reference('deployInfrastructure').outputs.cyrenIPDcrId.value]"
          },
          "cyrenMalwareDcrId": {
            "value": "[reference('deployInfrastructure').outputs.cyrenMalwareDcrId.value]"
          },
          "tacitRedApiKey": {
            "value": "[parameters('tacitRedApiKey')]"
          },
          "cyrenIPJwtToken": {
            "value": "[parameters('cyrenIPJwtToken')]"
          },
          "cyrenMalwareJwtToken": {
            "value": "[parameters('cyrenMalwareJwtToken')]"
          },
          "pollingFrequencyMinutes": {
            "value": "[parameters('pollingFrequencyMinutes')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "workspaceName": { "type": "string" },
            "dceEndpoint": { "type": "string" },
            "tacitRedDcrId": { "type": "string" },
            "cyrenIPDcrId": { "type": "string" },
            "cyrenMalwareDcrId": { "type": "string" },
            "tacitRedApiKey": { "type": "securestring" },
            "cyrenIPJwtToken": { "type": "securestring" },
            "cyrenMalwareJwtToken": { "type": "securestring" },
            "pollingFrequencyMinutes": { "type": "int" }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "apiVersion": "2024-09-01",
              "name": "[concat(parameters('workspaceName'), '/Microsoft.SecurityInsights/', variables('connectorDefinitionName'))]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "title": "Threat Intelligence Feeds (TacitRed + Cyren)",
                  "publisher": "TacitRed and Cyren",
                  "descriptionMarkdown": "Ingest threat intelligence from TacitRed (compromised credentials) and Cyren (IP reputation and malware URLs).",
                  "graphQueries": [
                    {
                      "metricName": "TacitRed Findings",
                      "legend": "TacitRed_Findings_CL",
                      "baseQuery": "TacitRed_Findings_CL"
                    },
                    {
                      "metricName": "Cyren Indicators",
                      "legend": "Cyren_Indicators_CL",
                      "baseQuery": "Cyren_Indicators_CL"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "TacitRed_Findings_CL",
                      "lastDataReceivedQuery": "TacitRed_Findings_CL | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
                    },
                    {
                      "name": "Cyren_Indicators_CL",
                      "lastDataReceivedQuery": "Cyren_Indicators_CL | summarize Time = max(TimeGenerated) | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "TacitRed_Findings_CL | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(7d)",
                        "Cyren_Indicators_CL | summarize LastLogReceived = max(TimeGenerated) | project IsConnected = LastLogReceived > ago(7d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": false
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "Configuration",
                      "description": "Enter your API credentials below to start ingesting threat intelligence data.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [ "WorkspaceName" ],
                            "label": "Workspace Name"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "apiVersion": "2022-10-01-preview",
              "name": "[concat(parameters('workspaceName'), '/Microsoft.SecurityInsights/TacitRedFindings')]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions', parameters('workspaceName'), 'Microsoft.SecurityInsights', variables('connectorDefinitionName'))]"
              ],
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "[variables('connectorDefinitionName')]",
                "dataType": "TacitRed_Findings_CL",
                "dcrConfig": {
                  "streamName": "Custom-TacitRed_Findings_CL",
                  "dataCollectionEndpoint": "[parameters('dceEndpoint')]",
                  "dataCollectionRuleImmutableId": "[parameters('tacitRedDcrId')]"
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[parameters('tacitRedApiKey')]",
                  "ApiKeyName": "Authorization"
                },
                "request": {
                  "apiEndpoint": "https://app.tacitred.com/api/v1/findings",
                  "httpMethod": "GET",
                  "queryParameters": {
                    "page_size": 100
                  },
                  "queryWindowInMin": "[parameters('pollingFrequencyMinutes')]",
                  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                  "startTimeAttributeName": "from",
                  "endTimeAttributeName": "until",
                  "rateLimitQps": 10,
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Accept": "application/json"
                  }
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageTokenJsonPath": "$.next_page",
                  "nextPageRequestQueryParameterName": "page"
                },
                "response": {
                  "eventsJsonPaths": [ "$.findings[*]" ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "apiVersion": "2022-10-01-preview",
              "name": "[concat(parameters('workspaceName'), '/Microsoft.SecurityInsights/CyrenIPReputation')]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions', parameters('workspaceName'), 'Microsoft.SecurityInsights', variables('connectorDefinitionName'))]"
              ],
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "[variables('connectorDefinitionName')]",
                "dataType": "Cyren_Indicators_CL",
                "dcrConfig": {
                  "streamName": "Custom-Cyren_Indicators_CL",
                  "dataCollectionEndpoint": "[parameters('dceEndpoint')]",
                  "dataCollectionRuleImmutableId": "[parameters('cyrenIPDcrId')]"
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[parameters('cyrenIPJwtToken')]",
                  "ApiKeyName": "Authorization",
                  "ApiKeyIdentifier": "Bearer"
                },
                "request": {
                  "apiEndpoint": "https://api-feeds.cyren.com/v1/feed/data",
                  "httpMethod": "GET",
                  "queryParameters": {
                    "feedId": "ip_reputation",
                    "count": 100,
                    "offset": 0,
                    "format": "jsonl"
                  },
                  "rateLimitQps": 10,
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Accept": "application/json"
                  }
                },
                "paging": {
                  "pagingType": "Offset",
                  "offsetParameterName": "offset",
                  "pageSize": 100
                },
                "response": {
                  "eventsJsonPaths": [ "$" ],
                  "format": "jsonl"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "apiVersion": "2022-10-01-preview",
              "name": "[concat(parameters('workspaceName'), '/Microsoft.SecurityInsights/CyrenMalwareURLs')]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions', parameters('workspaceName'), 'Microsoft.SecurityInsights', variables('connectorDefinitionName'))]"
              ],
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "[variables('connectorDefinitionName')]",
                "dataType": "Cyren_Indicators_CL",
                "dcrConfig": {
                  "streamName": "Custom-Cyren_Indicators_CL",
                  "dataCollectionEndpoint": "[parameters('dceEndpoint')]",
                  "dataCollectionRuleImmutableId": "[parameters('cyrenMalwareDcrId')]"
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[parameters('cyrenMalwareJwtToken')]",
                  "ApiKeyName": "Authorization",
                  "ApiKeyIdentifier": "Bearer"
                },
                "request": {
                  "apiEndpoint": "https://api-feeds.cyren.com/v1/feed/data",
                  "httpMethod": "GET",
                  "queryParameters": {
                    "feedId": "malware_urls",
                    "count": 100,
                    "offset": 0,
                    "format": "jsonl"
                  },
                  "rateLimitQps": 10,
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Accept": "application/json"
                  }
                },
                "paging": {
                  "pagingType": "Offset",
                  "offsetParameterName": "offset",
                  "pageSize": 100
                },
                "response": {
                  "eventsJsonPaths": [ "$" ],
                  "format": "jsonl"
                }
              }
            }
          ]
        }
      }
    }
  ],
  "outputs": {
    "workspaceName": {
      "type": "string",
      "value": "[parameters('workspaceName')]"
    },
    "connectorDefinitionName": {
      "type": "string",
      "value": "[variables('connectorDefinitionName')]"
    },
    "dceEndpoint": {
      "type": "string",
      "value": "[reference('deployInfrastructure').outputs.dceEndpoint.value]"
    }
  }
}
