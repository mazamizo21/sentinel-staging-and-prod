{
    "$schema":  "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion":  "1.0.0.0",
    "metadata":  {
                     "author":  "TacitRed \u0026 Cyren",
                     "comments":  "Threat Intelligence Feeds for Microsoft Sentinel - CCF Solution"
                 },
    "parameters":  {
                       "workspace":  {
                                         "type":  "string",
                                         "metadata":  {
                                                          "description":  "Workspace name for Microsoft Sentinel"
                                                      }
                                     },
                       "workspace-location":  {
                                                  "type":  "string",
                                                  "defaultValue":  "[resourceGroup().location]",
                                                  "metadata":  {
                                                                   "description":  "Location for workspace and solution resources"
                                                               }
                                              },
                       "tacitRedApiKey":  {
                                              "type":  "securestring",
                                              "metadata":  {
                                                               "description":  "TacitRed API Key for authentication"
                                                           }
                                          },
                       "cyrenIPJwtToken":  {
                                               "type":  "securestring",
                                               "metadata":  {
                                                                "description":  "Cyren JWT Token for IP Reputation feed"
                                                            }
                                           },
                       "cyrenMalwareJwtToken":  {
                                                    "type":  "securestring",
                                                    "metadata":  {
                                                                     "description":  "Cyren JWT Token for Malware URLs feed"
                                                                 }
                                                },
                       "deployAnalytics":  {
                                               "defaultValue":  true,
                                               "type":  "bool",
                                               "metadata":  {
                                                                "description":  "Deploy 3 pre-configured analytics rules"
                                                            }
                                           }
                   },
    "variables":  {
                      "workspaceResourceId":  "[resourceId(\u0027Microsoft.OperationalInsights/Workspaces\u0027, parameters(\u0027workspace\u0027))]",
                      "dceName":  "dce-threatintel-feeds",
                      "tacitRedDcrName":  "dcr-tacitred-findings",
                      "cyrenIPDcrName":  "dcr-cyren-ip-reputation",
                      "cyrenMalwareDcrName":  "dcr-cyren-malware-urls",
                      "_solutionName":  "ThreatIntelligenceFeeds",
                      "_solutionVersion":  "1.0.0",
                      "solutionId":  "threatintel.sentinel-solution-threatintel-feeds",
                      "dataConnectorContentId":  "ThreatIntelligenceFeeds",
                      "dataConnectorId":  "[extensionResourceId(resourceId(\u0027Microsoft.OperationalInsights/workspaces\u0027, parameters(\u0027workspace\u0027)), \u0027Microsoft.SecurityInsights/dataConnectorDefinitions\u0027, variables(\u0027dataConnectorContentId\u0027))]"
                  },
    "resources":  [
                      {
                          "type":  "Microsoft.Insights/dataCollectionEndpoints",
                          "apiVersion":  "2022-06-01",
                          "name":  "[variables(\u0027dceName\u0027)]",
                          "location":  "[parameters(\u0027workspace-location\u0027)]",
                          "properties":  {
                                             "networkAcls":  {
                                                                 "publicNetworkAccess":  "Enabled"
                                                             }
                                         }
                      },
                      {
                          "type":  "Microsoft.OperationalInsights/workspaces/tables",
                          "apiVersion":  "2023-09-01",
                          "name":  "[concat(parameters(\u0027workspace\u0027), \u0027/TacitRed_Findings_CL\u0027)]",
                          "properties":  {
                                             "schema":  {
                                                            "name":  "TacitRed_Findings_CL",
                                                            "columns":  [
                                                                            {
                                                                                "name":  "TimeGenerated",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "email_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "domain_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "findingType_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "confidence_d",
                                                                                "type":  "int"
                                                                            },
                                                                            {
                                                                                "name":  "firstSeen_t",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "lastSeen_t",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "notes_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "source_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "severity_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "status_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "campaign_id_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "user_id_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "username_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "detection_ts_t",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "metadata_s",
                                                                                "type":  "string"
                                                                            }
                                                                        ]
                                                        }
                                         }
                      },
                      {
                          "type":  "Microsoft.OperationalInsights/workspaces/tables",
                          "apiVersion":  "2023-09-01",
                          "name":  "[concat(parameters(\u0027workspace\u0027), \u0027/Cyren_Indicators_CL\u0027)]",
                          "properties":  {
                                             "schema":  {
                                                            "name":  "Cyren_Indicators_CL",
                                                            "columns":  [
                                                                            {
                                                                                "name":  "TimeGenerated",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "url_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "ip_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "fileHash_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "domain_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "protocol_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "port_d",
                                                                                "type":  "int"
                                                                            },
                                                                            {
                                                                                "name":  "category_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "risk_d",
                                                                                "type":  "int"
                                                                            },
                                                                            {
                                                                                "name":  "firstSeen_t",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "lastSeen_t",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "source_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "relationships_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "detection_methods_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "action_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "type_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "identifier_s",
                                                                                "type":  "string"
                                                                            },
                                                                            {
                                                                                "name":  "detection_ts_t",
                                                                                "type":  "datetime"
                                                                            },
                                                                            {
                                                                                "name":  "object_type_s",
                                                                                "type":  "string"
                                                                            }
                                                                        ]
                                                        }
                                         }
                      },
                      {
                          "type":  "Microsoft.Insights/dataCollectionRules",
                          "apiVersion":  "2022-06-01",
                          "name":  "[variables(\u0027tacitRedDcrName\u0027)]",
                          "location":  "[parameters(\u0027workspace-location\u0027)]",
                          "dependsOn":  [
                                            "[resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))]",
                                            "[resourceId(\u0027Microsoft.OperationalInsights/workspaces/tables\u0027, parameters(\u0027workspace\u0027), \u0027TacitRed_Findings_CL\u0027)]"
                                        ],
                          "properties":  {
                                             "dataCollectionEndpointId":  "[resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))]",
                                             "streamDeclarations":  {
                                                                        "Custom-TacitRed_Findings_CL":  {
                                                                                                            "columns":  [
                                                                                                                            {
                                                                                                                                "name":  "TimeGenerated",
                                                                                                                                "type":  "datetime"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "email",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "domain",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "findingType",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "confidence",
                                                                                                                                "type":  "int"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "firstSeen",
                                                                                                                                "type":  "datetime"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "lastSeen",
                                                                                                                                "type":  "datetime"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "notes",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "source",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "severity",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "status",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "campaign_id",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "user_id",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "username",
                                                                                                                                "type":  "string"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "detection_ts",
                                                                                                                                "type":  "datetime"
                                                                                                                            },
                                                                                                                            {
                                                                                                                                "name":  "metadata",
                                                                                                                                "type":  "string"
                                                                                                                            }
                                                                                                                        ]
                                                                                                        }
                                                                    },
                                             "destinations":  {
                                                                  "logAnalytics":  [
                                                                                       {
                                                                                           "workspaceResourceId":  "[variables(\u0027workspaceResourceId\u0027)]",
                                                                                           "name":  "clv2ws1"
                                                                                       }
                                                                                   ]
                                                              },
                                             "dataFlows":  [
                                                               {
                                                                   "streams":  [
                                                                                   "Custom-TacitRed_Findings_CL"
                                                                               ],
                                                                   "destinations":  [
                                                                                        "clv2ws1"
                                                                                    ],
                                                                   "transformKql":  "source | extend TimeGenerated = now()",
                                                                   "outputStream":  "Custom-TacitRed_Findings_CL"
                                                               }
                                                           ]
                                         }
                      },
                      {
                          "type":  "Microsoft.Insights/dataCollectionRules",
                          "apiVersion":  "2022-06-01",
                          "name":  "[variables(\u0027cyrenIPDcrName\u0027)]",
                          "location":  "[parameters(\u0027workspace-location\u0027)]",
                          "dependsOn":  [
                                            "[resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))]",
                                            "[resourceId(\u0027Microsoft.OperationalInsights/workspaces/tables\u0027, parameters(\u0027workspace\u0027), \u0027Cyren_Indicators_CL\u0027)]"
                                        ],
                          "properties":  {
                                             "dataCollectionEndpointId":  "[resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))]",
                                             "streamDeclarations":  {
                                                                        "Custom-Cyren_Indicators_CL":  {
                                                                                                           "columns":  [
                                                                                                                           {
                                                                                                                               "name":  "TimeGenerated",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "url",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "ip",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "fileHash",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "domain",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "protocol",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "port",
                                                                                                                               "type":  "int"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "category",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "risk",
                                                                                                                               "type":  "int"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "firstSeen",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "lastSeen",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "source",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "relationships",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "detection_methods",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "action",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "type",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "identifier",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "detection_ts",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "object_type",
                                                                                                                               "type":  "string"
                                                                                                                           }
                                                                                                                       ]
                                                                                                       }
                                                                    },
                                             "destinations":  {
                                                                  "logAnalytics":  [
                                                                                       {
                                                                                           "workspaceResourceId":  "[variables(\u0027workspaceResourceId\u0027)]",
                                                                                           "name":  "clv2ws1"
                                                                                       }
                                                                                   ]
                                                              },
                                             "dataFlows":  [
                                                               {
                                                                   "streams":  [
                                                                                   "Custom-Cyren_Indicators_CL"
                                                                               ],
                                                                   "destinations":  [
                                                                                        "clv2ws1"
                                                                                    ],
                                                                   "transformKql":  "source | extend TimeGenerated = now()",
                                                                   "outputStream":  "Custom-Cyren_Indicators_CL"
                                                               }
                                                           ]
                                         }
                      },
                      {
                          "type":  "Microsoft.Insights/dataCollectionRules",
                          "apiVersion":  "2022-06-01",
                          "name":  "[variables(\u0027cyrenMalwareDcrName\u0027)]",
                          "location":  "[parameters(\u0027workspace-location\u0027)]",
                          "dependsOn":  [
                                            "[resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))]",
                                            "[resourceId(\u0027Microsoft.OperationalInsights/workspaces/tables\u0027, parameters(\u0027workspace\u0027), \u0027Cyren_Indicators_CL\u0027)]"
                                        ],
                          "properties":  {
                                             "dataCollectionEndpointId":  "[resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))]",
                                             "streamDeclarations":  {
                                                                        "Custom-Cyren_Indicators_CL":  {
                                                                                                           "columns":  [
                                                                                                                           {
                                                                                                                               "name":  "TimeGenerated",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "url",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "ip",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "fileHash",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "domain",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "protocol",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "port",
                                                                                                                               "type":  "int"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "category",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "risk",
                                                                                                                               "type":  "int"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "firstSeen",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "lastSeen",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "source",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "relationships",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "detection_methods",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "action",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "type",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "identifier",
                                                                                                                               "type":  "string"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "detection_ts",
                                                                                                                               "type":  "datetime"
                                                                                                                           },
                                                                                                                           {
                                                                                                                               "name":  "object_type",
                                                                                                                               "type":  "string"
                                                                                                                           }
                                                                                                                       ]
                                                                                                       }
                                                                    },
                                             "destinations":  {
                                                                  "logAnalytics":  [
                                                                                       {
                                                                                           "workspaceResourceId":  "[variables(\u0027workspaceResourceId\u0027)]",
                                                                                           "name":  "clv2ws1"
                                                                                       }
                                                                                   ]
                                                              },
                                             "dataFlows":  [
                                                               {
                                                                   "streams":  [
                                                                                   "Custom-Cyren_Indicators_CL"
                                                                               ],
                                                                   "destinations":  [
                                                                                        "clv2ws1"
                                                                                    ],
                                                                   "transformKql":  "source | extend TimeGenerated = now()",
                                                                   "outputStream":  "Custom-Cyren_Indicators_CL"
                                                               }
                                                           ]
                                         }
                      }
                  ],
    "outputs":  {
                    "dceEndpoint":  {
                                        "type":  "string",
                                        "value":  "[reference(resourceId(\u0027Microsoft.Insights/dataCollectionEndpoints\u0027, variables(\u0027dceName\u0027))).logsIngestion.endpoint]"
                                    },
                    "tacitRedDcrImmutableId":  {
                                                   "type":  "string",
                                                   "value":  "[reference(resourceId(\u0027Microsoft.Insights/dataCollectionRules\u0027, variables(\u0027tacitRedDcrName\u0027))).immutableId]"
                                               },
                    "cyrenIPDcrImmutableId":  {
                                                  "type":  "string",
                                                  "value":  "[reference(resourceId(\u0027Microsoft.Insights/dataCollectionRules\u0027, variables(\u0027cyrenIPDcrName\u0027))).immutableId]"
                                              },
                    "cyrenMalwareDcrImmutableId":  {
                                                       "type":  "string",
                                                       "value":  "[reference(resourceId(\u0027Microsoft.Insights/dataCollectionRules\u0027, variables(\u0027cyrenMalwareDcrName\u0027))).immutableId]"
                                                   }
                }
}
