{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "TacitRed",
    "comments": "TacitRed-Only Threat Intelligence Solution for Microsoft Sentinel - Infrastructure + CCF Connector + Analytics"
  },
  "parameters": {
    "workspace": {
      "type": "string",
      "metadata": {
        "description": "Workspace name for Microsoft Sentinel"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for workspace and solution resources"
      }
    },
    "tacitRedApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "TacitRed API Key for authentication"
      }
    },
    "deployAnalytics": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy TacitRed analytics rule for threat detection"
      }
    },
    "deployConnectors": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Automatically configure CCF connector definition and data connectors via deployment script"
      }
    },
    "forceUpdateTag": {
      "type": "string",
      "defaultValue": "[utcNow('u')]",
      "metadata": {
        "description": "Change value to force re-execution of the deployment script."
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dceName": "dce-tacitred-threatintel",
    "tacitRedDcrName": "dcr-tacitred-findings",
    "uamiName": "uami-tacitred-ccf-deployment"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2022-06-01",
      "name": "[variables('dceName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "networkAcls": {
          "publicNetworkAccess": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2023-09-01",
      "name": "[concat(parameters('workspace'), '/TacitRed_Findings_CL')]",
      "properties": {
        "schema": {
          "name": "TacitRed_Findings_CL",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime"
            },
            {
              "name": "email_s",
              "type": "string"
            },
            {
              "name": "domain_s",
              "type": "string"
            },
            {
              "name": "findingType_s",
              "type": "string"
            },
            {
              "name": "confidence_d",
              "type": "int"
            },
            {
              "name": "firstSeen_t",
              "type": "datetime"
            },
            {
              "name": "lastSeen_t",
              "type": "datetime"
            },
            {
              "name": "notes_s",
              "type": "string"
            },
            {
              "name": "source_s",
              "type": "string"
            },
            {
              "name": "severity_s",
              "type": "string"
            },
            {
              "name": "status_s",
              "type": "string"
            },
            {
              "name": "campaign_id_s",
              "type": "string"
            },
            {
              "name": "user_id_s",
              "type": "string"
            },
            {
              "name": "username_s",
              "type": "string"
            },
            {
              "name": "detection_ts_t",
              "type": "datetime"
            },
            {
              "name": "metadata_s",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[variables('tacitRedDcrName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), 'TacitRed_Findings_CL')]"
      ],
      "properties": {
        "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
        "streamDeclarations": {
          "Custom-TacitRed_Findings_CL": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "email",
                "type": "string"
              },
              {
                "name": "domain",
                "type": "string"
              },
              {
                "name": "findingType",
                "type": "string"
              },
              {
                "name": "confidence",
                "type": "int"
              },
              {
                "name": "firstSeen",
                "type": "datetime"
              },
              {
                "name": "lastSeen",
                "type": "datetime"
              },
              {
                "name": "notes",
                "type": "string"
              },
              {
                "name": "source",
                "type": "string"
              },
              {
                "name": "severity",
                "type": "string"
              },
              {
                "name": "status",
                "type": "string"
              },
              {
                "name": "campaign_id",
                "type": "string"
              },
              {
                "name": "user_id",
                "type": "string"
              },
              {
                "name": "username",
                "type": "string"
              },
              {
                "name": "detection_ts",
                "type": "datetime"
              },
              {
                "name": "metadata",
                "type": "string"
              }
            ]
          }
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "clv2ws1"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Custom-TacitRed_Findings_CL"
            ],
            "destinations": [
              "clv2ws1"
            ],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "Custom-TacitRed_Findings_CL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('uamiName')]",
      "location": "[parameters('workspace-location')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(variables('workspaceResourceId'), variables('uamiName'), 'sentinel-contributor')]",
      "scope": "[variables('workspaceResourceId')]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName')), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, variables('uamiName'), 'rg-contributor')]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName')), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "condition": "[parameters('deployConnectors')]",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "configure-tacitred-ccf-connector",
      "location": "[parameters('workspace-location')]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('uamiName'))]": {}
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))]",
        "[resourceId('Microsoft.Insights/dataCollectionRules', variables('tacitRedDcrName'))]",
        "[extensionResourceId(variables('workspaceResourceId'), 'Microsoft.Authorization/roleAssignments', guid(variables('workspaceResourceId'), variables('uamiName'), 'sentinel-contributor'))]"
      ],
      "properties": {
        "forceUpdateTag": "[parameters('forceUpdateTag')]",
        "azCliVersion": "2.51.0",
        "timeout": "PT20M",
        "cleanupPreference": "OnSuccess",
        "retentionInterval": "P1D",
        "environmentVariables": [
          {
            "name": "WORKSPACE_ID",
            "value": "[variables('workspaceResourceId')]"
          },
          {
            "name": "SUBSCRIPTION_ID",
            "value": "[subscription().subscriptionId]"
          },
          {
            "name": "RESOURCE_GROUP",
            "value": "[resourceGroup().name]"
          },
          {
            "name": "DCE_ENDPOINT",
            "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName')), '2022-06-01', 'full').properties.logsIngestion.endpoint]"
          },
          {
            "name": "DCR_TACITRED",
            "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('tacitRedDcrName')), '2022-06-01', 'full').properties.immutableId]"
          },
          {
            "name": "TACITRED_APIKEY",
            "secureValue": "[parameters('tacitRedApiKey')]"
          }
        ],
        "scriptContent": "#!/usr/bin/env bash\nset -euo pipefail\n\necho 'Logging in with managed identity'\naz login --identity --allow-no-subscriptions >/dev/null\n\necho \"Setting subscription ${SUBSCRIPTION_ID}\"\naz account set --subscription \"${SUBSCRIPTION_ID}\"\n\n# Allow RBAC propagation before calling SecurityInsights APIs\nsleep 20\n\nBASE_URL=\"https://management.azure.com${WORKSPACE_ID}/providers/Microsoft.SecurityInsights\"\n\necho 'Creating TacitRed connector definition...'\naz rest --method PUT --url \"${BASE_URL}/dataConnectorDefinitions/TacitRedThreatIntel?api-version=2024-09-01\" --headers \"Content-Type=application/json\" --body @- <<'DEF_EOF' || true\n{\n  \"kind\": \"Customizable\",\n  \"properties\": {\n    \"connectorUiConfig\": {\n      \"id\": \"TacitRedThreatIntel\",\n      \"title\": \"TacitRed Compromised Credentials\",\n      \"publisher\": \"TacitRed\",\n      \"permissions\": {\n        \"resourceProvider\": [\n          {\n            \"provider\": \"Microsoft.OperationalInsights/workspaces\",\n            \"permissionsDisplayText\": \"read and write permissions are required\",\n            \"providerDisplayName\": \"Workspace\",\n            \"scope\": \"Workspace\",\n            \"requiredPermissions\": { \"write\": true, \"read\": true, \"delete\": false }\n          },\n          {\n            \"provider\": \"Microsoft.OperationalInsights/workspaces/sharedKeys\",\n            \"permissionsDisplayText\": \"read permissions to shared keys for the workspace are required\",\n            \"providerDisplayName\": \"Keys\",\n            \"scope\": \"Workspace\",\n            \"requiredPermissions\": { \"action\": true }\n          }\n        ],\n        \"customs\": [\n          { \"name\": \"TacitRed API Key\", \"description\": \"TacitRed API key is required for authentication\" }\n        ]\n      }\n    }\n  }\n}\nDEF_EOF\n\necho 'Creating TacitRed data connector...'\naz rest --method PUT --url \"${BASE_URL}/dataConnectors/TacitRedFindings?api-version=2022-10-01-preview\" --headers \"Content-Type=application/json\" --body @- <<EOF\n{\n  \"kind\": \"RestApiPoller\",\n  \"properties\": {\n    \"connectorDefinitionName\": \"TacitRedThreatIntel\",\n    \"dataType\": \"TacitRed_Findings_CL\",\n    \"dcrConfig\": {\n      \"streamName\": \"Custom-TacitRed_Findings_CL\",\n      \"dataCollectionEndpoint\": \"${DCE_ENDPOINT}\",\n      \"dataCollectionRuleImmutableId\": \"${DCR_TACITRED}\"\n    },\n    \"auth\": {\n      \"type\": \"APIKey\",\n      \"ApiKey\": \"${TACITRED_APIKEY}\",\n      \"ApiKeyName\": \"Authorization\"\n    },\n    \"request\": {\n      \"apiEndpoint\": \"https://app.tacitred.com/api/v1/findings\",\n      \"httpMethod\": \"GET\",\n      \"queryParameters\": { \"page_size\": 100 },\n      \"queryWindowInMin\": 360,\n      \"queryTimeFormat\": \"yyyy-MM-ddTHH:mm:ssZ\",\n      \"startTimeAttributeName\": \"from\",\n      \"endTimeAttributeName\": \"until\",\n      \"rateLimitQps\": 10,\n      \"retryCount\": 3,\n      \"timeoutInSeconds\": 60,\n      \"headers\": { \"Accept\": \"application/json\", \"User-Agent\": \"Microsoft-Sentinel-TacitRed/1.0\" }\n    },\n    \"paging\": { \"pagingType\": \"LinkHeader\", \"linkHeaderRelLinkName\": \"rel=next\" },\n    \"response\": { \"eventsJsonPaths\": [\"$.results\"] }\n  }\n}\nEOF\n\necho 'TacitRed CCF connector configured successfully'"
      }
    },
    {
      "condition": "[parameters('deployAnalytics')]",
      "type": "Microsoft.SecurityInsights/alertRules",
      "apiVersion": "2023-02-01",
      "scope": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
      "name": "[guid(resourceGroup().id, 'RepeatCompromise')]",
      "kind": "Scheduled",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspace'), 'TacitRed_Findings_CL')]"
      ],
      "properties": {
        "displayName": "TacitRed - Repeat Compromise Detection",
        "description": "Detects users who have been compromised multiple times within a 7-day window. This may indicate a persistent threat or inadequate remediation.",
        "severity": "High",
        "enabled": true,
        "query": "let lookbackPeriod = 7d;\nlet threshold = 2;\nTacitRed_Findings_CL\n| where TimeGenerated >= ago(lookbackPeriod)\n| extend Email = tostring(email_s), Username = tostring(username_s), Domain = tostring(domain_s), FindingType = tostring(findingType_s), Confidence = todouble(confidence_d), FirstSeen = todatetime(firstSeen_t), LastSeen = todatetime(lastSeen_t), Notes = tostring(notes_s)\n| summarize CompromiseCount = count(), FindingTypes = make_set(FindingType), FirstCompromise = min(FirstSeen), LatestCompromise = max(LastSeen), AverageConfidence = avg(Confidence), Domains = make_set(Domain), AllNotes = make_list(Notes) by Email, Username\n| where CompromiseCount >= threshold\n| extend CompromiseWindow = datetime_diff('day', LatestCompromise, FirstCompromise), Severity = case(CompromiseCount >= 5, 'Critical', CompromiseCount >= 3, 'High', 'Medium')\n| project Email, Username, CompromiseCount, Severity, FirstCompromise, LatestCompromise, CompromiseWindow, AverageConfidence, FindingTypes, Domains, AllNotes\n| order by CompromiseCount desc, LatestCompromise desc",
        "queryFrequency": "PT1H",
        "queryPeriod": "P7D",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "tactics": [
          "CredentialAccess"
        ],
        "techniques": [
          "T1110"
        ],
        "incidentConfiguration": {
          "createIncident": true,
          "groupingConfiguration": {
            "enabled": true,
            "reopenClosedIncident": false,
            "lookbackDuration": "P7D",
            "matchingMethod": "Selected",
            "groupByEntities": [
              "Account"
            ],
            "groupByAlertDetails": [],
            "groupByCustomDetails": []
          }
        },
        "eventGroupingSettings": {
          "aggregationKind": "AlertPerResult"
        },
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "Repeat Compromise: {{Email}} ({{CompromiseCount}}x)",
          "alertDescriptionFormat": "User {{Email}} compromised {{CompromiseCount}} times",
          "alertSeverityColumnName": "Severity"
        },
        "customDetails": {
          "CompromiseCount": "CompromiseCount",
          "FirstCompromise": "FirstCompromise",
          "LatestCompromise": "LatestCompromise",
          "AverageConfidence": "AverageConfidence"
        },
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "Email"
              },
              {
                "identifier": "Name",
                "columnName": "Username"
              }
            ]
          }
        ]
      }
    }
  ],
  "outputs": {
    "dceEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', variables('dceName'))).logsIngestion.endpoint]"
    },
    "tacitRedDcrImmutableId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', variables('tacitRedDcrName'))).immutableId]"
    },
    "deploymentMessage": {
      "type": "string",
      "value": "TacitRed-only infrastructure, CCF connector, and analytics deployed successfully."
    }
  }
}
