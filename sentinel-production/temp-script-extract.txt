#!/usr/bin/env bash
set -euo pipefail

echo 'Logging in with managed identity'
az login --identity --allow-no-subscriptions >/dev/null

echo "Setting subscription ${SUBSCRIPTION_ID}"
az account set --subscription "${SUBSCRIPTION_ID}"

# Allow RBAC propagation before calling SecurityInsights APIs
sleep 20

BASE_URL="https://management.azure.com${WORKSPACE_ID}/providers/Microsoft.SecurityInsights"

echo 'Creating connector definition (ThreatIntelligenceFeeds)...'
az rest --method PUT --url "${BASE_URL}/dataConnectorDefinitions/ThreatIntelligenceFeeds?api-version=2024-09-01" --headers "Content-Type=application/json" --body @- <<'DEF_EOF' || true
{
  "kind": "Customizable",
  "properties": {
    "connectorUiConfig": {
      "id": "ThreatIntelligenceFeeds",
      "title": "Threat Intelligence Feeds (TacitRed + Cyren)",
      "publisher": "TacitRed & Cyren",
      "descriptionMarkdown": "Ingest threat intelligence from TacitRed (compromised credentials) and Cyren (IP reputation, malware URLs) to identify and respond to threats targeting your organization.",
      "graphQueriesTableName": "ThreatIntel_CL",
      "graphQueries": [{
        "metricName": "Total threat indicators received",
        "legend": "Threat Indicators",
        "baseQuery": "union TacitRed_Findings_CL, Cyren_Indicators_CL"
      }],
      "sampleQueries": [
        {
          "description": "TacitRed - Compromised credentials from last 7 days",
          "query": "TacitRed_Findings_CL | where TimeGenerated >= ago(7d) | where findingType_s == 'compromised_credential' | project TimeGenerated, email_s, domain_s, confidence_d, source_s"
        },
        {
          "description": "Cyren - High-risk indicators (risk >= 70)",
          "query": "Cyren_Indicators_CL | where risk_d >= 70 | summarize count() by category_s, bin(TimeGenerated, 1h) | render timechart"
        },
        {
          "description": "Cross-feed correlation - Compromised users accessing malicious IPs",
          "query": "TacitRed_Findings_CL | join kind=inner (Cyren_Indicators_CL | where category_s == 'malware') on $left.domain_s == $right.domain_s | project TimeGenerated, email_s, domain_s, risk_d, category_s"
        }
      ],
      "dataTypes": [
        { "name": "TacitRed_Findings_CL", "lastDataReceivedQuery": "TacitRed_Findings_CL | summarize Time = max(TimeGenerated) | where isnotempty(Time)" },
        { "name": "Cyren_Indicators_CL", "lastDataReceivedQuery": "Cyren_Indicators_CL | summarize Time = max(TimeGenerated) | where isnotempty(Time)" }
      ],
      "connectivityCriteria": [{ "type": "HasDataConnectors", "value": [] }],
      "availability": { "status": "Available", "isPreview": false }
    }
  }
}
DEF_EOF || true

echo 'Patching connector definition with required permissions (minimal)...'
az rest --method PUT --url "${BASE_URL}/dataConnectorDefinitions/ThreatIntelligenceFeeds?api-version=2024-09-01" --headers "Content-Type=application/json" --body @- <<'DEF_MIN'
{
  "kind": "Customizable",
  "properties": {
    "connectorUiConfig": {
      "id": "ThreatIntelligenceFeeds",
      "title": "Threat Intelligence Feeds (TacitRed + Cyren)",
      "publisher": "TacitRed & Cyren",
      "permissions": {
        "resourceProvider": [
          {
            "provider": "Microsoft.OperationalInsights/workspaces",
            "permissionsDisplayText": "read and write permissions are required",
            "providerDisplayName": "Workspace",
            "scope": "Workspace",
            "requiredPermissions": { "write": true, "read": true, "delete": false }
          },
          {
            "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
            "permissionsDisplayText": "read permissions to shared keys for the workspace are required",
            "providerDisplayName": "Keys",
            "scope": "Workspace",
            "requiredPermissions": { "action": true }
          }
        ],
        "customs": [
          { "name": "TacitRed API Key", "description": "TacitRed API key is required for authentication. Obtain from TacitRed admin console." },
          { "name": "Cyren JWT Tokens", "description": "Cyren JWT tokens are required for both IP Reputation and Malware URLs feeds. Obtain from Cyren portal." }
        ]
      },
      "instructionSteps": [
        { "title": "1. Configure TacitRed API Access", "description": "Obtain your TacitRed API key from the TacitRed admin console", "instructions": [ { "parameters": { "label": "TacitRed API Key", "placeholder": "Enter your TacitRed API Key", "type": "password", "name": "tacitRedApiKey" }, "type": "Textbox" } ] },
        { "title": "2. Configure Cyren API Access", "description": "Obtain your Cyren JWT tokens for IP Reputation and Malware URLs feeds", "instructions": [ { "parameters": { "label": "Cyren IP Reputation JWT Token", "placeholder": "Enter JWT token for IP Reputation feed", "type": "password", "name": "cyrenIPJwtToken" }, "type": "Textbox" }, { "parameters": { "label": "Cyren Malware URLs JWT Token", "placeholder": "Enter JWT token for Malware URLs feed", "type": "password", "name": "cyrenMalwareJwtToken" }, "type": "Textbox" } ] }
      ]
    }
  }
}
DEF_MIN

echo 'Creating data connector: TacitRedFindings'
az rest --method PUT --url "${BASE_URL}/dataConnectors/TacitRedFindings?api-version=2022-10-01-preview" --headers "Content-Type=application/json" --body @- <<EOF
{
  "kind": "RestApiPoller",
  "properties": {
    "connectorDefinitionName": "ThreatIntelligenceFeeds",
    "dataType": "TacitRed_Findings_CL",
    "dcrConfig": {
      "streamName": "Custom-TacitRed_Findings_CL",
      "dataCollectionEndpoint": "${DCE_ENDPOINT}",
      "dataCollectionRuleImmutableId": "${DCR_TACITRED}"
    },
    "auth": {
      "type": "APIKey",
      "ApiKey": "${TACITRED_APIKEY}",
      "ApiKeyName": "Authorization"
    },
    "request": {
      "apiEndpoint": "https://app.tacitred.com/api/v1/findings",
      "httpMethod": "GET",
      "queryParameters": { "page_size": 100 },
      "queryWindowInMin": 360,
      "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
      "startTimeAttributeName": "from",
      "endTimeAttributeName": "until",
      "rateLimitQps": 10,
      "retryCount": 3,
      "timeoutInSeconds": 60,
      "headers": { "Accept": "application/json", "User-Agent": "Microsoft-Sentinel-TacitRed/1.0" }
    },
    "paging": { "pagingType": "LinkHeader", "linkHeaderRelLinkName": "rel=next" },
    "response": { "eventsJsonPaths": ["$.results"] }
  }
}
EOF

echo 'Creating data connector: CyrenIPReputation'
az rest --method PUT --url "${BASE_URL}/dataConnectors/CyrenIPReputation?api-version=2022-10-01-preview" --headers "Content-Type=application/json" --body @- <<EOF
{
  "kind": "RestApiPoller",
  "properties": {
    "connectorDefinitionName": "ThreatIntelligenceFeeds",
    "dataType": "Cyren_Indicators_CL",
    "dcrConfig": {
      "streamName": "Custom-Cyren_Indicators_CL",
      "dataCollectionEndpoint": "${DCE_ENDPOINT}",
      "dataCollectionRuleImmutableId": "${DCR_CYRENIP}"
    },
    "auth": {
      "type": "APIKey",
      "ApiKey": "${CYREN_IP_JWT}",
      "ApiKeyName": "Authorization",
      "ApiKeyIdentifier": "Bearer"
    },
    "request": {
      "apiEndpoint": "https://api-feeds.cyren.com/v1/feed/data",
      "httpMethod": "GET",
      "queryParameters": { "feedId": "ip_reputation", "count": 100, "offset": 0, "format": "jsonl" },
      "rateLimitQps": 10,
      "retryCount": 3,
      "timeoutInSeconds": 60,
      "headers": { "Accept": "application/json", "User-Agent": "Microsoft-Sentinel-Cyren/1.0" }
    },
    "paging": { "pagingType": "Offset", "offsetParameterName": "offset", "pageSize": 100 },
    "response": { "eventsJsonPaths": ["$"], "format": "jsonl" }
  }
}
EOF

echo 'Creating data connector: CyrenMalwareURLs'
az rest --method PUT --url "${BASE_URL}/dataConnectors/CyrenMalwareURLs?api-version=2022-10-01-preview" --headers "Content-Type=application/json" --body @- <<EOF
{
  "kind": "RestApiPoller",
  "properties": {
    "connectorDefinitionName": "ThreatIntelligenceFeeds",
    "dataType": "Cyren_Indicators_CL",
    "dcrConfig": {
      "streamName": "Custom-Cyren_Indicators_CL",
      "dataCollectionEndpoint": "${DCE_ENDPOINT}",
      "dataCollectionRuleImmutableId": "${DCR_CYRENMALWARE}"
    },
    "auth": {
      "type": "APIKey",
      "ApiKey": "${CYREN_MALWARE_JWT}",
      "ApiKeyName": "Authorization",
      "ApiKeyIdentifier": "Bearer"
    },
    "request": {
      "apiEndpoint": "https://api-feeds.cyren.com/v1/feed/data",
      "httpMethod": "GET",
      "queryParameters": { "feedId": "malware_urls", "count": 100, "offset": 0, "format": "jsonl" },
      "rateLimitQps": 10,
      "retryCount": 3,
      "timeoutInSeconds": 60,
      "headers": { "Accept": "application/json", "User-Agent": "Microsoft-Sentinel-Cyren/1.0" }
    },
    "paging": { "pagingType": "Offset", "offsetParameterName": "offset", "pageSize": 100 },
    "response": { "eventsJsonPaths": ["$"], "format": "jsonl" }
  }
}
EOF

echo 'All CCF connectors configured.'

