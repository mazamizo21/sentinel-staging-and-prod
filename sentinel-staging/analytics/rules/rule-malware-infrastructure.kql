// Analytics Rule: New Malware Infrastructure on Known Compromised Domain
// Detects when compromised domains (TacitRed) host malware/phishing infrastructure
// Severity: High
// Tactics: Command and Control, Initial Access
// Frequency: Every 8 hours
// Query Period: 8 hours
// VERSION: Works WITHOUT parser functions (uses raw tables directly)

let lookbackPeriod = 30d;
let cyrenActiveWindow = 30d; // Consider Cyren indicators active if seen in last 30 days
// Get TacitRed compromised domains
let CompromisedDomains = TacitRed_Findings_CL
    | where TimeGenerated >= ago(lookbackPeriod)
    | where isnotempty(domain_s)
    | extend DomainRaw = tolower(tostring(domain_s))
    | extend Parts = split(DomainRaw, '.')
    | extend RegDomain = iif(array_length(Parts) >= 2, strcat(Parts[-2], '.', Parts[-1]), DomainRaw)
    | summarize 
        CompromisedUsers = make_set(tostring(email_s)),
        UserCount = dcount(tostring(email_s)),
        FirstCompromise = min(todatetime(firstSeen_t)),
        LatestCompromise = max(todatetime(lastSeen_t)),
        FindingTypes = make_set(tostring(findingType_s)),
        AvgConfidence = avg(todouble(confidence_d))
        by RegDomain;
// Get active Cyren malicious indicators
let ActiveMaliciousInfra = Cyren_Indicators_CL
    | where TimeGenerated >= ago(lookbackPeriod)
    | where todatetime(lastSeen_t) >= ago(cyrenActiveWindow)
    | extend RiskScore = toint(risk_d),
             Url = tostring(url_s),
             RawDomain = tolower(tostring(domain_s)),
             Ip = tostring(ip_s),
             Category = tolower(tostring(category_s)),
             Type = tolower(tostring(type_s))
    | extend Host = iif(isnotempty(RawDomain), RawDomain, extract(@"://([^/]+)", 1, Url))
    | where isnotempty(Host)
    | extend Parts = split(Host, '.')
    | extend RegDomain = iif(array_length(Parts) >= 2, strcat(Parts[-2], '.', Parts[-1]), Host)
    | where RiskScore >= 60
    | where (Category in ('malware','phishing')) or (Type in ('malware','phishing'))
    | summarize 
        MaliciousIOCs = make_set(coalesce(Url, Host, Ip)),
        IOCTypes = make_set(Type),
        Categories = make_set(Category),
        MaxRiskScore = max(RiskScore),
        FirstSeen = min(todatetime(firstSeen_t)),
        LastSeen = max(todatetime(lastSeen_t))
        by RegDomain;
// Correlate compromised domains with malicious infrastructure
CompromisedDomains
| join kind=inner (ActiveMaliciousInfra) on RegDomain
| extend
    Severity = case(
        MaxRiskScore >= 80 and AvgConfidence >= 80, "Critical",
        MaxRiskScore >= 60 or AvgConfidence >= 80, "High",
        "Medium"
    ),
    ThreatDescription = strcat(
        "Domain ", RegDomain, " has ", UserCount, " compromised users (TacitRed) and is actively hosting malicious content (Cyren). ",
        "Cyren risk score: ", MaxRiskScore, ". ",
        "TacitRed confidence: ", round(AvgConfidence, 0), "%. ",
        "This indicates active exploitation of compromised credentials."
    )
| project
    Domain = RegDomain,
    Severity,
    CompromisedUsers,
    UserCount,
    LatestCompromise,
    MaliciousIOCs,
    IOCTypes,
    Categories,
    MaxRiskScore,
    AvgConfidence,
    FindingTypes,
    ThreatDescription,
    CyrenFirstSeen = FirstSeen,
    CyrenLastSeen = LastSeen
| order by Severity desc, UserCount desc
