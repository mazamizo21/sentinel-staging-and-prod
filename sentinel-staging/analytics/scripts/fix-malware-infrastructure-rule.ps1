#!/usr/bin/env pwsh
#Requires -Version 7.0

<#
.SYNOPSIS
    Fixes the "New Malware Infrastructure on Known Compromised Domain" Analytics rule

.DESCRIPTION
    This script automatically updates the Analytics rule with the corrected KQL query.
    Fixes syntax errors: variable name typo, wrong operators, missing null checks.

.PARAMETER WorkspaceName
    Name of the Log Analytics Workspace

.PARAMETER ResourceGroup
    Resource Group containing the workspace

.PARAMETER RuleName
    Display name of the Analytics rule to fix (default: "New Malware Infrastructure on Known Compromised Domain")

.PARAMETER DryRun
    If specified, shows what would be updated without making changes

.EXAMPLE
    .\fix-malware-infrastructure-rule.ps1 -WorkspaceName "sentinel-workspace" -ResourceGroup "rg-sentinel"

.EXAMPLE
    .\fix-malware-infrastructure-rule.ps1 -WorkspaceName "sentinel-workspace" -ResourceGroup "rg-sentinel" -DryRun

.NOTES
    Author: AI Security Engineer
    Date: November 10, 2025
    Requires: Azure CLI with Sentinel extension
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory = $true)]
    [string]$WorkspaceName,

    [Parameter(Mandatory = $true)]
    [string]$ResourceGroup,

    [Parameter(Mandatory = $false)]
    [string]$RuleName = "New Malware Infrastructure on Known Compromised Domain",

    [Parameter(Mandatory = $false)]
    [switch]$DryRun
)

$ErrorActionPreference = "Stop"
$ProgressPreference = "SilentlyContinue"

# Color output functions
function Write-Header { param([string]$Message) Write-Host "`n═══ $Message ═══" -ForegroundColor Cyan }
function Write-Success { param([string]$Message) Write-Host "✅ $Message" -ForegroundColor Green }
function Write-Info { param([string]$Message) Write-Host "ℹ️  $Message" -ForegroundColor Blue }
function Write-Warning { param([string]$Message) Write-Host "⚠️  $Message" -ForegroundColor Yellow }
function Write-Error { param([string]$Message) Write-Host "❌ $Message" -ForegroundColor Red }

Write-Header "Analytics Rule Fix: Malware Infrastructure Correlation"

# Validate Azure CLI is installed
Write-Info "Validating Azure CLI installation..."
try {
    $azVersion = az version --query '\"azure-cli\"' -o tsv 2>$null
    if (-not $azVersion) { throw "Azure CLI not found" }
    Write-Success "Azure CLI version: $azVersion"
} catch {
    Write-Error "Azure CLI is not installed or not in PATH"
    Write-Info "Install from: https://docs.microsoft.com/cli/azure/install-azure-cli"
    exit 1
}

# Validate logged in
Write-Info "Checking Azure authentication..."
try {
    $account = az account show 2>$null | ConvertFrom-Json
    if (-not $account) { throw "Not logged in" }
    Write-Success "Logged in as: $($account.user.name)"
    Write-Info "Subscription: $($account.name) ($($account.id))"
} catch {
    Write-Error "Not logged into Azure. Run: az login"
    exit 1
}

# Get workspace details
Write-Info "Retrieving workspace details..."
try {
    $workspace = az monitor log-analytics workspace show `
        --resource-group $ResourceGroup `
        --workspace-name $WorkspaceName `
        2>$null | ConvertFrom-Json
    
    if (-not $workspace) { throw "Workspace not found" }
    
    Write-Success "Found workspace: $WorkspaceName"
    Write-Info "Location: $($workspace.location)"
    Write-Info "Resource ID: $($workspace.id)"
} catch {
    Write-Error "Failed to retrieve workspace: $_"
    exit 1
}

# Find the Analytics rule
Write-Info "Searching for Analytics rule: $RuleName"
try {
    $rules = az sentinel alert-rule list `
        --resource-group $ResourceGroup `
        --workspace-name $WorkspaceName `
        2>$null | ConvertFrom-Json
    
    $targetRule = $rules | Where-Object { 
        $_.properties.displayName -eq $RuleName 
    }
    
    if (-not $targetRule) {
        Write-Warning "Rule '$RuleName' not found in workspace"
        Write-Info "Available rules:"
        $rules | ForEach-Object { Write-Info "  - $($_.properties.displayName)" }
        exit 1
    }
    
    Write-Success "Found rule: $RuleName"
    Write-Info "Rule ID: $($targetRule.name)"
    Write-Info "Current status: $($targetRule.properties.enabled ? 'Enabled' : 'Disabled')"
} catch {
    Write-Error "Failed to retrieve Analytics rules: $_"
    exit 1
}

# Load corrected query
$queryPath = Join-Path $PSScriptRoot ".." "rules" "rule-malware-infrastructure-correlation.kql"
if (-not (Test-Path $queryPath)) {
    Write-Error "Corrected query file not found: $queryPath"
    exit 1
}

Write-Info "Loading corrected query from: $queryPath"
$correctedQuery = Get-Content -Path $queryPath -Raw

# Display current vs corrected query
Write-Header "Query Comparison"
Write-Host "Current Query (first 200 chars):" -ForegroundColor Yellow
Write-Host $targetRule.properties.query.Substring(0, [Math]::Min(200, $targetRule.properties.query.Length))
Write-Host "`n..." -ForegroundColor DarkGray
Write-Host "`nCorrected Query (first 200 chars):" -ForegroundColor Green
Write-Host $correctedQuery.Substring(0, [Math]::Min(200, $correctedQuery.Length))
Write-Host "`n..." -ForegroundColor DarkGray

if ($DryRun) {
    Write-Warning "DRY RUN MODE - No changes will be made"
    Write-Info "Changes that would be applied:"
    Write-Info "  • Update query with corrected KQL syntax"
    Write-Info "  • Fix variable name: CompromisedDomainint → CompromisedDomains"
    Write-Info "  • Fix operator: 'is' → 'in'"
    Write-Info "  • Add null checks with isnotempty()"
    Write-Success "Dry run completed successfully"
    exit 0
}

# Confirm update
Write-Warning "This will update the Analytics rule with the corrected query."
$confirmation = Read-Host "Continue? (yes/no)"
if ($confirmation -ne "yes") {
    Write-Info "Operation cancelled by user"
    exit 0
}

# Create update payload
Write-Info "Preparing rule update..."
$updatePayload = @{
    kind = $targetRule.kind
    properties = @{
        displayName = $targetRule.properties.displayName
        description = $targetRule.properties.description
        severity = $targetRule.properties.severity
        enabled = $targetRule.properties.enabled
        query = $correctedQuery
        queryFrequency = $targetRule.properties.queryFrequency
        queryPeriod = $targetRule.properties.queryPeriod
        triggerOperator = $targetRule.properties.triggerOperator
        triggerThreshold = $targetRule.properties.triggerThreshold
        suppressionDuration = $targetRule.properties.suppressionDuration
        suppressionEnabled = $targetRule.properties.suppressionEnabled
        tactics = $targetRule.properties.tactics
        techniques = $targetRule.properties.techniques
        incidentConfiguration = $targetRule.properties.incidentConfiguration
        eventGroupingSettings = $targetRule.properties.eventGroupingSettings
    }
}

# Add optional properties if they exist
if ($targetRule.properties.alertDetailsOverride) {
    $updatePayload.properties.alertDetailsOverride = $targetRule.properties.alertDetailsOverride
}
if ($targetRule.properties.customDetails) {
    $updatePayload.properties.customDetails = $targetRule.properties.customDetails
}
if ($targetRule.properties.entityMappings) {
    $updatePayload.properties.entityMappings = $targetRule.properties.entityMappings
}

# Save payload to temp file
$tempFile = [System.IO.Path]::GetTempFileName()
$updatePayload | ConvertTo-Json -Depth 10 | Set-Content -Path $tempFile

try {
    Write-Info "Updating Analytics rule..."
    
    $result = az sentinel alert-rule update `
        --resource-group $ResourceGroup `
        --workspace-name $WorkspaceName `
        --alert-rule-id $targetRule.name `
        --alert-rule-payload "@$tempFile" `
        2>&1
    
    if ($LASTEXITCODE -ne 0) {
        throw "Azure CLI command failed: $result"
    }
    
    Write-Success "Analytics rule updated successfully!"
    
    # Verify update
    Write-Info "Verifying update..."
    $updatedRule = az sentinel alert-rule show `
        --resource-group $ResourceGroup `
        --workspace-name $WorkspaceName `
        --alert-rule-id $targetRule.name `
        2>$null | ConvertFrom-Json
    
    if ($updatedRule.properties.query -eq $correctedQuery) {
        Write-Success "Query update verified"
    } else {
        Write-Warning "Query verification inconclusive - please check Azure Portal"
    }
    
} catch {
    Write-Error "Failed to update rule: $_"
    Write-Info "Manual update may be required via Azure Portal"
    exit 1
} finally {
    # Cleanup temp file
    if (Test-Path $tempFile) {
        Remove-Item -Path $tempFile -Force
    }
}

Write-Header "Fix Summary"
Write-Success "Analytics rule has been corrected"
Write-Info "Rule Name: $RuleName"
Write-Info "Workspace: $WorkspaceName"
Write-Info "Resource Group: $ResourceGroup"
Write-Info "Status: $($targetRule.properties.enabled ? 'Enabled' : 'Disabled')"

Write-Header "Next Steps"
Write-Info "1. Navigate to Azure Portal → Sentinel → Analytics"
Write-Info "2. Find the rule: $RuleName"
Write-Info "3. Click 'Edit' and go to 'Set rule logic'"
Write-Info "4. Click 'Results simulation' to test the query"
Write-Info "5. Verify no errors appear"
Write-Info "6. Monitor rule execution over the next 8 hours"

Write-Success "Fix completed successfully!"
